<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flow Chat - Professional Messaging</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- PWA Manifest -->
    <link rel="manifest" id="manifest">
    <meta name="theme-color" content="#00a884">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <style>
        /* Reset & Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: #0c1317;
            color: #e9edef;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 0;
            overflow: hidden;
        }

        body.light-mode {
            background: #f0f2f5;
            color: #111b21;
        }

        /* WhatsApp-like UI */
        .app-container {
            display: none;
            width: 100%;
            max-width: 1600px;
            height: 95vh;
            background: #0c1317;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 6px 24px rgba(0,0,0,0.4);
        }

        .light-mode .app-container {
            background: #ffffff;
            box-shadow: 0 6px 24px rgba(0,0,0,0.1);
        }

        /* PWA Install Prompt */
        .install-prompt {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #202c33;
            color: #e9edef;
            padding: 12px 16px;
            display: none;
            justify-content: space-between;
            align-items: center;
            z-index: 2000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .light-mode .install-prompt {
            background: #ffffff;
            color: #111b21;
            border-bottom: 1px solid #e9edef;
        }

        .install-prompt button {
            background: #00a884;
            color: #111b21;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Sidebar */
        .sidebar {
            width: 380px;
            background: #111b21;
            border-right: 1px solid #2a3942;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .light-mode .sidebar {
            background: #ffffff;
            border-right: 1px solid #e9edef;
        }

        .header {
            padding: 10px 16px;
            background: #202c33;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        .light-mode .header {
            background: #f0f2f5;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
        }

        .user-name {
            font-weight: 600;
            color: #e9edef;
            font-size: 16px;
        }

        .light-mode .user-name {
            color: #111b21;
        }

        .user-status {
            font-size: 13px;
            color: #8696a0;
            margin-top: 2px;
        }

        .header-icons {
            display: flex;
            gap: 20px;
            color: #aebac1;
        }

        .header-icons i {
            font-size: 20px;
            cursor: pointer;
            transition: color 0.2s;
        }

        .header-icons i:hover {
            color: #d1d7db;
        }

        /* Search */
        .search-container {
            padding: 10px 12px;
            background: #111b21;
            transition: all 0.3s ease;
        }

        .light-mode .search-container {
            background: #ffffff;
        }

        .search-container.hidden {
            padding: 0;
            height: 0;
            overflow: hidden;
        }

        .search-box {
            background: #202c33;
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .light-mode .search-box {
            background: #f0f2f5;
        }

        .search-box i {
            color: #8696a0;
            font-size: 16px;
        }

        .search-box input {
            background: transparent;
            border: none;
            color: #e9edef;
            font-size: 15px;
            width: 100%;
            outline: none;
        }

        .light-mode .search-box input {
            color: #111b21;
        }

        .search-box input::placeholder {
            color: #8696a0;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background: #111b21;
            border-bottom: 1px solid #2a3942;
        }

        .light-mode .tabs {
            background: #ffffff;
            border-bottom: 1px solid #e9edef;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 16px 0;
            color: #8696a0;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            position: relative;
        }

        .tab.active {
            color: #00a884;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: #00a884;
            border-radius: 2px;
        }

        /* Chat List */
        .chat-list {
            flex: 1;
            overflow-y: auto;
            background: #111b21;
        }

        .light-mode .chat-list {
            background: #ffffff;
        }

        .chat-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #222e35;
            transition: background 0.2s;
        }

        .light-mode .chat-item {
            border-bottom: 1px solid #f0f2f5;
        }

        .chat-item:hover {
            background: #202c33;
        }

        .light-mode .chat-item:hover {
            background: #f8f9fa;
        }

        .chat-item.active {
            background: #2a3942;
        }

        .light-mode .chat-item.active {
            background: #e9edef;
        }

        .chat-avatar {
            width: 49px;
            height: 49px;
            border-radius: 50%;
            object-fit: cover;
            position: relative;
        }

        .online-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            background: #00a884;
            border-radius: 50%;
            border: 2px solid #111b21;
        }

        .light-mode .online-indicator {
            border-color: #ffffff;
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chat-name {
            font-weight: 600;
            color: #e9edef;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .light-mode .chat-name {
            color: #111b21;
        }

        .chat-time {
            font-size: 12px;
            color: #8696a0;
            white-space: nowrap;
        }

        .chat-preview {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .last-message {
            font-size: 14px;
            color: #8696a0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .unread-count {
            background: #00a884;
            color: #111b21;
            font-size: 12px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }

        /* Users List */
        .users-list {
            flex: 1;
            overflow-y: auto;
            background: #111b21;
            display: none;
        }

        .light-mode .users-list {
            background: #ffffff;
        }

        .user-list-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #222e35;
            transition: background 0.2s;
        }

        .light-mode .user-list-item {
            border-bottom: 1px solid #f0f2f5;
        }

        .user-list-item:hover {
            background: #202c33;
        }

        .light-mode .user-list-item:hover {
            background: #f8f9fa;
        }

        .user-list-info {
            flex: 1;
        }

        .user-list-name {
            font-weight: 600;
            color: #e9edef;
            font-size: 16px;
        }

        .light-mode .user-list-name {
            color: #111b21;
        }

        .user-list-status {
            font-size: 13px;
            color: #8696a0;
            margin-top: 2px;
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0c1317;
            position: relative;
        }

        .light-mode .chat-area {
            background: #ffffff;
        }

        .chat-header-main {
            padding: 10px 16px;
            background: #202c33;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #2a3942;
            height: 60px;
        }

        .light-mode .chat-header-main {
            background: #f0f2f5;
            border-bottom: 1px solid #e9edef;
        }

        .back-button {
            background: none;
            border: none;
            color: #8696a0;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            margin-right: 10px;
            display: none;
        }

        .chat-partner-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #8696a0;
            margin-top: 2px;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 4px;
            height: 4px;
            background: #8696a0;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-4px); }
        }

        /* Messages Container */
        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-image: url('https://web.whatsapp.com/img/bg-chat-tile-dark_9f39b5e.png');
            background-repeat: repeat;
            display: flex;
            flex-direction: column;
            gap: 4px;
            position: relative;
        }

        .light-mode .messages-container {
            background-image: url('https://web.whatsapp.com/img/bg-chat-tile-light_aeb6c6e.png');
        }

        .message-date {
            text-align: center;
            margin: 20px 0;
        }

        .date-label {
            background: #182229;
            color: #8696a0;
            font-size: 12px;
            padding: 5px 12px;
            border-radius: 7px;
            display: inline-block;
        }

        .light-mode .date-label {
            background: #ffffff;
            border: 1px solid #e9edef;
        }

        .message-wrapper {
            display: flex;
            margin: 2px 0;
            position: relative;
        }

        .message-wrapper.sent {
            justify-content: flex-end;
        }

        .message-wrapper.received {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 65%;
            padding: 8px 12px;
            border-radius: 7.5px;
            position: relative;
            word-wrap: break-word;
            font-size: 14.2px;
            line-height: 19px;
        }

        .message-bubble.sent {
            background: #005c4b;
            border-top-right-radius: 0;
            margin-right: 10px;
        }

        .light-mode .message-bubble.sent {
            background: #d9fdd3;
            color: #111b21;
        }

        .message-bubble.received {
            background: #202c33;
            border-top-left-radius: 0;
            margin-left: 10px;
        }

        .light-mode .message-bubble.received {
            background: #ffffff;
            color: #111b21;
            border: 1px solid #e9edef;
        }

        .message-info {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
            font-size: 11px;
        }

        .message-time {
            color: rgba(255,255,255,0.6);
        }

        .light-mode .message-time {
            color: #667781;
        }

        .light-mode .message-bubble.sent .message-time {
            color: rgba(0,0,0,0.6);
        }

        .message-status {
            color: rgba(255,255,255,0.6);
            font-size: 10px;
        }

        .light-mode .message-status {
            color: #667781;
        }

        .message-status i {
            font-size: 12px;
        }

        .seen-status {
            color: #53bdeb;
        }

        /* Message Input */
        .message-input-container {
            padding: 10px 16px;
            background: #202c33;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .light-mode .message-input-container {
            background: #f0f2f5;
        }

        .input-icons {
            display: flex;
            gap: 15px;
            color: #8696a0;
            font-size: 24px;
            cursor: pointer;
        }

        .message-input-wrapper {
            flex: 1;
            background: #2a3942;
            border-radius: 8px;
            padding: 9px 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .light-mode .message-input-wrapper {
            background: #ffffff;
            border: 1px solid #e9edef;
        }

        .message-input {
            background: transparent;
            border: none;
            color: #e9edef;
            font-size: 15px;
            width: 100%;
            outline: none;
            resize: none;
            max-height: 100px;
            font-family: inherit;
        }

        .light-mode .message-input {
            color: #111b21;
        }

        .message-input::placeholder {
            color: #8696a0;
        }

        .send-button {
            background: #00a884;
            color: #111b21;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
        }

        .send-button:hover {
            background: #06cf9c;
        }

        .send-button i {
            font-size: 18px;
        }

        /* Delete Confirmation */
        .delete-confirmation {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .delete-modal {
            background: #233138;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .light-mode .delete-modal {
            background: #ffffff;
        }

        .delete-header {
            padding: 20px;
            border-bottom: 1px solid #2a3942;
            text-align: center;
        }

        .light-mode .delete-header {
            border-bottom: 1px solid #e9edef;
        }

        .delete-body {
            padding: 20px;
            text-align: center;
            color: #d1d7db;
            font-size: 15px;
        }

        .light-mode .delete-body {
            color: #111b21;
        }

        .delete-actions {
            display: flex;
            border-top: 1px solid #2a3942;
        }

        .light-mode .delete-actions {
            border-top: 1px solid #e9edef;
        }

        .delete-btn {
            flex: 1;
            padding: 16px;
            background: none;
            border: none;
            color: #d1d7db;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .light-mode .delete-btn {
            color: #111b21;
        }

        .delete-btn:hover {
            background: #2a3942;
        }

        .light-mode .delete-btn:hover {
            background: #f8f9fa;
        }

        .delete-btn.delete {
            color: #f15c6d;
            border-left: 1px solid #2a3942;
        }

        .light-mode .delete-btn.delete {
            border-left: 1px solid #e9edef;
        }

        .delete-btn.delete:hover {
            background: #3a2426;
        }

        .light-mode .delete-btn.delete:hover {
            background: #fff5f5;
        }

        /* Authentication */
        .auth-container {
            background: #111b21;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            width: 100%;
            max-width: 400px;
        }

        .light-mode .auth-container {
            background: #ffffff;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .auth-form h2 {
            color: #00a884;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }

        .auth-form input {
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 16px;
            background: #2a3942;
            border: 1px solid #3a4a52;
            border-radius: 8px;
            color: #e9edef;
            font-size: 15px;
            transition: border-color 0.2s;
        }

        .light-mode .auth-form input {
            background: #ffffff;
            border: 1px solid #e9edef;
            color: #111b21;
        }

        .auth-form input:focus {
            outline: none;
            border-color: #00a884;
        }

        .auth-form button {
            width: 100%;
            padding: 14px;
            background: #00a884;
            color: #111b21;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .auth-form button:hover {
            background: #06cf9c;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
            color: #8696a0;
        }

        .light-mode .auth-toggle {
            color: #667781;
        }

        .auth-toggle span {
            color: #00a884;
            cursor: pointer;
            font-weight: 500;
        }

        .error-message {
            background: #3a2426;
            color: #f15c6d;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            display: none;
            font-size: 14px;
        }

        .light-mode .error-message {
            background: #ffeaea;
        }

        /* Profile Modal */
        .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .profile-content {
            background: #111b21;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .light-mode .profile-content {
            background: #ffffff;
        }

        .profile-header {
            padding: 20px;
            border-bottom: 1px solid #2a3942;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .light-mode .profile-header {
            border-bottom: 1px solid #e9edef;
        }

        .profile-header h2 {
            color: #e9edef;
        }

        .light-mode .profile-header h2 {
            color: #111b21;
        }

        .close-btn {
            background: none;
            border: none;
            color: #8696a0;
            font-size: 24px;
            cursor: pointer;
        }

        .profile-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #8696a0;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .light-mode .form-group label {
            color: #667781;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: #2a3942;
            border: 1px solid #3a4a52;
            border-radius: 8px;
            color: #e9edef;
            font-size: 15px;
        }

        .light-mode .form-group input,
        .light-mode .form-group textarea,
        .light-mode .form-group select {
            background: #ffffff;
            border: 1px solid #e9edef;
            color: #111b21;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .avatar-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .avatar-option {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 3px solid transparent;
            transition: border-color 0.3s;
        }

        .avatar-option.selected {
            border-color: #00a884;
        }

        .profile-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .profile-actions button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
        }

        .save-btn {
            background: #00a884;
            color: #111b21;
        }

        .cancel-btn {
            background: #2a3942;
            color: #e9edef;
        }

        .light-mode .cancel-btn {
            background: #e9edef;
            color: #111b21;
        }

        .logout-btn {
            background: #f15c6d;
            color: white;
        }

        /* Username Badge */
        .username-badge {
            display: inline-block;
            background: #2a3942;
            color: #8696a0;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
        }

        .light-mode .username-badge {
            background: #f0f2f5;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #00a884;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #374045;
            border-radius: 4px;
        }

        .light-mode ::-webkit-scrollbar-thumb {
            background: #c5c5c5;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4a5a60;
        }

        .light-mode ::-webkit-scrollbar-thumb:hover {
            background: #a0a0a0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container {
                height: 100vh;
                border-radius: 0;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .chat-area {
                display: none;
            }
            
            .chat-area.active {
                display: flex;
            }

            .settings-content {
                width: 100%;
                max-width: none;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }
        }

        /* Selection Menu */
        .message-selection {
            position: fixed;
            background: #202c33;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            padding: 8px 0;
            z-index: 10000;
            display: none;
            min-width: 200px;
            max-width: 250px;
            transform: translate(-50%, -100%);
        }

        .light-mode .message-selection {
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .selection-item {
            padding: 12px 20px;
            color: #e9edef;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .light-mode .selection-item {
            color: #111b21;
        }

        .selection-item:hover {
            background: #2a3942;
        }

        .light-mode .selection-item:hover {
            background: #f8f9fa;
        }

        .selection-item i {
            color: #8696a0;
            font-size: 18px;
            width: 24px;
            text-align: center;
        }

        .selection-item.delete i {
            color: #f15c6d;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #202c33;
            color: #e9edef;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 3000;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .light-mode .toast {
            background: #ffffff;
            color: #111b21;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .toast.show {
            display: flex;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Info Message */
        .info-message {
            padding: 10px 15px;
            margin: 10px 20px;
            background: #202c33;
            border-radius: 8px;
            color: #8696a0;
            font-size: 14px;
            text-align: center;
            border-left: 3px solid #00a884;
        }

        .light-mode .info-message {
            background: #f0f2f5;
            color: #667781;
        }

        /* Settings Modal */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .settings-content {
            background: #111b21;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .light-mode .settings-content {
            background: #ffffff;
        }

        .settings-header {
            padding: 20px;
            border-bottom: 1px solid #2a3942;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: #111b21;
            z-index: 1;
        }

        .light-mode .settings-header {
            background: #ffffff;
            border-bottom: 1px solid #e9edef;
        }

        .settings-header h2 {
            color: #e9edef;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .light-mode .settings-header h2 {
            color: #111b21;
        }

        .settings-body {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 768px) {
            .settings-body {
                grid-template-columns: 1fr;
                padding-bottom: 100px;
            }
        }

        .settings-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #2a3942;
        }

        .light-mode .settings-section {
            border-bottom: 1px solid #e9edef;
        }

        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .settings-section h3 {
            color: #00a884;
            margin-bottom: 15px;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
            cursor: pointer;
            transition: background 0.2s;
            border-radius: 8px;
            padding-left: 10px;
            padding-right: 10px;
            margin-bottom: 5px;
        }

        .settings-item:hover {
            background: #202c33;
        }

        .light-mode .settings-item:hover {
            background: #f8f9fa;
        }

        .settings-item-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .settings-item-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: #2a3942;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #00a884;
            font-size: 16px;
        }

        .light-mode .settings-item-icon {
            background: #f0f2f5;
        }

        .settings-item-text {
            flex: 1;
        }

        .settings-item-title {
            color: #e9edef;
            font-weight: 600;
            font-size: 15px;
        }

        .light-mode .settings-item-title {
            color: #111b21;
        }

        .settings-item-desc {
            color: #8696a0;
            font-size: 13px;
            margin-top: 2px;
        }

        .settings-item-action {
            color: #00a884;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
        }

        .settings-item-action i {
            font-size: 12px;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #2a3942;
            transition: .4s;
            border-radius: 34px;
        }

        .light-mode .toggle-slider {
            background-color: #e9edef;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: #e9edef;
            transition: .4s;
            border-radius: 50%;
        }

        .light-mode .toggle-slider:before {
            background-color: #111b21;
        }

        input:checked + .toggle-slider {
            background-color: #00a884;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Signup Steps */
        .signup-steps {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            position: relative;
        }

        .step-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 1;
            width: 80px;
        }

        .step-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #2a3942;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #8696a0;
            font-weight: 600;
            margin-bottom: 8px;
            border: 2px solid #2a3942;
            transition: all 0.3s ease;
        }

        .light-mode .step-circle {
            background: #e9edef;
            border-color: #e9edef;
            color: #667781;
        }

        .step-indicator.active .step-circle {
            background: #00a884;
            color: #111b21;
            border-color: #00a884;
        }

        .step-indicator.completed .step-circle {
            background: #00a884;
            color: #111b21;
            border-color: #00a884;
        }

        .step-indicator.completed .step-circle:after {
            content: 'âœ“';
            font-size: 16px;
        }

        .step-label {
            font-size: 12px;
            color: #8696a0;
            text-align: center;
            max-width: 80px;
        }

        .light-mode .step-label {
            color: #667781;
        }

        .step-indicator.active .step-label {
            color: #00a884;
            font-weight: 500;
        }

        .step-indicator.completed .step-label {
            color: #8696a0;
        }

        .light-mode .step-indicator.completed .step-label {
            color: #667781;
        }

        .step-connector {
            position: absolute;
            top: 18px;
            left: 20%;
            right: 20%;
            height: 2px;
            background: #2a3942;
            z-index: 0;
        }

        .light-mode .step-connector {
            background: #e9edef;
        }

        .step-connector-line {
            height: 100%;
            background: #00a884;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Signup Steps Content */
        .step-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .step-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 10px;
        }

        .step-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s;
            min-width: 100px;
        }

        .step-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .step-btn.back {
            background: #2a3942;
            color: #e9edef;
        }

        .light-mode .step-btn.back {
            background: #e9edef;
            color: #111b21;
        }

        .step-btn.back:hover:not(:disabled) {
            background: #3a4a52;
        }

        .light-mode .step-btn.back:hover:not(:disabled) {
            background: #d1d7db;
        }

        .step-btn.next {
            background: #00a884;
            color: #111b21;
        }

        .step-btn.next:hover:not(:disabled) {
            background: #06cf9c;
        }

        .step-btn.submit {
            background: #00a884;
            color: #111b21;
            width: 100%;
        }

        .step-btn.submit:hover:not(:disabled) {
            background: #06cf9c;
        }

        /* Password Strength Indicator */
        .password-strength {
            margin-top: 8px;
        }

        .strength-meter {
            height: 4px;
            background: #2a3942;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .light-mode .strength-meter {
            background: #e9edef;
        }

        .strength-fill {
            height: 100%;
            width: 0%;
            transition: width 0.3s ease, background 0.3s ease;
            border-radius: 2px;
        }

        .strength-text {
            font-size: 12px;
            color: #8696a0;
        }

        .light-mode .strength-text {
            color: #667781;
        }

        .strength-weak { background: #f15c6d; }
        .strength-fair { background: #f39c12; }
        .strength-good { background: #f1c40f; }
        .strength-strong { background: #2ecc71; }
        .strength-very-strong { background: #00a884; }

        /* Progress Bar */
        .signup-progress {
            width: 100%;
            height: 4px;
            background: #2a3942;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .light-mode .signup-progress {
            background: #e9edef;
        }

        .progress-fill {
            height: 100%;
            background: #00a884;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Terms and Conditions */
        .terms-container {
            max-height: 200px;
            overflow-y: auto;
            background: #2a3942;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #3a4a52;
        }

        .light-mode .terms-container {
            background: #f8f9fa;
            border: 1px solid #e9edef;
        }

        .terms-content {
            color: #d1d7db;
            font-size: 13px;
            line-height: 1.5;
        }

        .light-mode .terms-content {
            color: #667781;
        }

        .terms-content h4 {
            color: #e9edef;
            margin: 15px 0 8px 0;
        }

        .light-mode .terms-content h4 {
            color: #111b21;
        }

        .terms-content p {
            margin-bottom: 10px;
        }

        .terms-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 15px;
        }

        .terms-checkbox input {
            margin-top: 3px;
        }

        .terms-checkbox label {
            font-size: 14px;
            color: #d1d7db;
            cursor: pointer;
        }

        .light-mode .terms-checkbox label {
            color: #667781;
        }

        .terms-checkbox label a {
            color: #00a884;
            text-decoration: none;
        }

        .terms-checkbox label a:hover {
            text-decoration: underline;
        }

        /* Step Review */
        .review-info {
            background: #2a3942;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .light-mode .review-info {
            background: #f8f9fa;
        }

        .review-item {
            display: flex;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #3a4a52;
        }

        .light-mode .review-item {
            border-bottom: 1px solid #e9edef;
        }

        .review-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .review-label {
            width: 120px;
            color: #8696a0;
            font-size: 14px;
            font-weight: 500;
        }

        .light-mode .review-label {
            color: #667781;
        }

        .review-value {
            flex: 1;
            color: #e9edef;
            font-size: 15px;
            word-break: break-word;
            font-weight: 500;
        }

        .light-mode .review-value {
            color: #111b21;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #00a884;
            margin-bottom: 10px;
        }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            background: #202c33;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            padding: 8px 0;
            min-width: 200px;
            z-index: 1001;
            display: none;
            right: 10px;
            top: 70px;
        }

        .light-mode .dropdown-menu {
            background: #ffffff;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .dropdown-menu.show {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dropdown-item {
            padding: 12px 20px;
            color: #e9edef;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .light-mode .dropdown-item {
            color: #111b21;
        }

        .dropdown-item:hover {
            background: #2a3942;
        }

        .light-mode .dropdown-item:hover {
            background: #f8f9fa;
        }

        .dropdown-item i {
            color: #8696a0;
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        .dropdown-item.logout i {
            color: #f15c6d;
        }

        .dropdown-item.profile i {
            color: #00a884;
        }

        .dropdown-item.settings i {
            color: #3498db;
        }

        .dropdown-divider {
            height: 1px;
            background: #2a3942;
            margin: 5px 0;
        }

        .light-mode .dropdown-divider {
            background: #e9edef;
        }

        /* Phone Input Styles */
        .phone-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
        }

        .country-select-wrapper {
            position: relative;
            width: 130px;
        }

        .country-select-wrapper select {
            width: 100%;
            padding: 14px 16px 14px 40px;
            background: #2a3942;
            border: 1px solid #3a4a52;
            border-radius: 8px;
            color: #e9edef;
            font-size: 15px;
            appearance: none;
            cursor: pointer;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%238696a0" height="20" viewBox="0 0 24 24" width="20" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
        }

        .light-mode .country-select-wrapper select {
            background: #ffffff;
            border: 1px solid #e9edef;
            color: #111b21;
        }

        .country-flag {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 15px;
            object-fit: cover;
            border-radius: 2px;
            border: 1px solid rgba(0,0,0,0.1);
            pointer-events: none;
        }

        .phone-input-wrapper {
            flex: 1;
        }

        .phone-input-wrapper input {
            width: 100%;
            padding: 14px 16px;
            background: #2a3942;
            border: 1px solid #3a4a52;
            border-radius: 8px;
            color: #e9edef;
            font-size: 15px;
        }

        .light-mode .phone-input-wrapper input {
            background: #ffffff;
            border: 1px solid #e9edef;
            color: #111b21;
        }

        /* Country option in dropdown */
        .country-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
        }

        .country-flag-small {
            width: 20px;
            height: 15px;
            object-fit: cover;
            border-radius: 2px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .country-name {
            flex: 1;
            font-size: 14px;
        }

        .country-code {
            font-size: 14px;
            color: #8696a0;
        }

        .light-mode .country-code {
            color: #667781;
        }

        /* Fix for dropdown scroll */
        select option {
            background: #202c33;
            color: #e9edef;
            padding: 8px;
        }

        .light-mode select option {
            background: #ffffff;
            color: #111b21;
        }

        /* Sub-settings modal */
        .sub-settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2001;
        }

        .sub-settings-content {
            background: #111b21;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .light-mode .sub-settings-content {
            background: #ffffff;
        }

        .sub-settings-header {
            padding: 20px;
            border-bottom: 1px solid #2a3942;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: #111b21;
            z-index: 1;
        }

        .light-mode .sub-settings-header {
            background: #ffffff;
            border-bottom: 1px solid #e9edef;
        }

        .sub-settings-header h3 {
            color: #e9edef;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .light-mode .sub-settings-header h3 {
            color: #111b21;
        }

        .sub-settings-body {
            padding: 20px;
        }

        .sub-settings-section {
            margin-bottom: 25px;
        }

        .sub-settings-section h4 {
            color: #00a884;
            margin-bottom: 15px;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sub-settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #2a3942;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .light-mode .sub-settings-item {
            background: #f8f9fa;
        }

        .sub-settings-item-text {
            flex: 1;
        }

        .sub-settings-item-title {
            color: #e9edef;
            font-weight: 500;
            font-size: 14px;
        }

        .light-mode .sub-settings-item-title {
            color: #111b21;
        }

        .sub-settings-item-desc {
            color: #8696a0;
            font-size: 12px;
            margin-top: 2px;
        }

        .light-mode .sub-settings-item-desc {
            color: #667781;
        }

        /* Badge for counts */
        .badge {
            background: #00a884;
            color: #111b21;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Text button */
        .text-button {
            background: none;
            border: none;
            color: #00a884;
            font-size: 14px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .text-button:hover {
            background: rgba(0, 168, 132, 0.1);
        }

        /* Danger button */
        .danger-button {
            background: none;
            border: none;
            color: #f15c6d;
            font-size: 14px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
        }

        .danger-button:hover {
            background: rgba(241, 92, 109, 0.1);
        }
    </style>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- PWA Install Prompt -->
    <div class="install-prompt" id="installPrompt">
        <div>
            <strong>Install Flow Chat</strong>
            <div style="font-size: 14px; color: #8696a0;">For better experience, install our app</div>
        </div>
        <button onclick="installApp()">Install</button>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastMessage"></span>
    </div>

    <!-- Authentication -->
    <div class="auth-container" id="authContainer">
        <div class="auth-form">
            <h2><i class="fas fa-comments"></i> Flow Chat</h2>
            <div class="error-message" id="authError"></div>
            
            <!-- Step-by-Step Signup -->
            <div id="signUpForm" style="display: none;">
                <!-- Progress Bar -->
                <div class="signup-progress">
                    <div class="progress-fill" id="signupProgress"></div>
                </div>
                
                <!-- Step Indicators -->
                <div class="signup-steps">
                    <div class="step-connector">
                        <div class="step-connector-line" id="stepConnector"></div>
                    </div>
                    <div class="step-indicator active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Account</div>
                    </div>
                    <div class="step-indicator" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Profile</div>
                    </div>
                    <div class="step-indicator" id="step3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Security</div>
                    </div>
                    <div class="step-indicator" id="step4">
                        <div class="step-circle">4</div>
                        <div class="step-label">Review</div>
                    </div>
                </div>
                
                <!-- Step 1: Account Information -->
                <div class="step-content active" id="stepContent1">
                    <h3 style="color: #00a884; margin-bottom: 20px; text-align: center;">Create Your Account</h3>
                    <input type="text" id="signUpName" placeholder="Full Name" required>
                    <input type="email" id="signUpEmail" placeholder="Email Address" required>
                    
                    <!-- Updated Phone Input with Country Flags -->
                    <div class="phone-input-container">
                        <div class="country-select-wrapper">
                            <select id="signUpCountryCode">
                                <!-- Options will be populated by JavaScript -->
                            </select>
                            <img id="selectedCountryFlag" class="country-flag" src="" alt="">
                        </div>
                        <div class="phone-input-wrapper">
                            <input type="tel" id="signUpPhone" placeholder="Phone Number">
                        </div>
                    </div>
                    
                    <div class="step-navigation">
                        <div></div>
                        <button class="step-btn next" onclick="goToStep(2)">Next <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                
                <!-- Step 2: Profile Information -->
                <div class="step-content" id="stepContent2">
                    <h3 style="color: #00a884; margin-bottom: 20px; text-align: center;">Complete Your Profile</h3>
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Alex" alt="Avatar Preview" class="avatar-preview" id="avatarPreview" onclick="document.getElementById('avatarUpload').click()">
                        <button onclick="document.getElementById('avatarUpload').click()" style="margin-top: 5px; padding: 8px 12px; background: #2a3942; color: #e9edef; border: none; border-radius: 6px; cursor: pointer;">
                            <i class="fas fa-camera"></i> Upload Photo
                        </button>
                        <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                    </div>
                    <input type="text" id="signUpUsername" placeholder="Username (for searching)" required>
                    <select id="signUpGender" style="width: 100%; padding: 14px 16px; margin-bottom: 16px; background: #2a3942; border: 1px solid #3a4a52; border-radius: 8px; color: #e9edef;">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                        <option value="prefer-not-to-say">Prefer not to say</option>
                    </select>
                    <select id="signUpStatus" style="width: 100%; padding: 14px 16px; margin-bottom: 16px; background: #2a3942; border: 1px solid #3a4a52; border-radius: 8px; color: #e9edef;">
                        <option value="">Select Status</option>
                        <option value="student">Student</option>
                        <option value="professional">Professional</option>
                        <option value="entrepreneur">Entrepreneur</option>
                        <option value="other">Other</option>
                    </select>
                    <div class="step-navigation">
                        <button class="step-btn back" onclick="goToStep(1)"><i class="fas fa-arrow-left"></i> Back</button>
                        <button class="step-btn next" onclick="goToStep(3)">Next <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                
                <!-- Step 3: Security -->
                <div class="step-content" id="stepContent3">
                    <h3 style="color: #00a884; margin-bottom: 20px; text-align: center;">Account Security</h3>
                    <input type="password" id="signUpPassword" placeholder="Create Password" required oninput="checkPasswordStrength()">
                    <div class="password-strength">
                        <div class="strength-meter">
                            <div class="strength-fill" id="passwordStrengthFill"></div>
                        </div>
                        <div class="strength-text" id="passwordStrengthText">Password strength</div>
                    </div>
                    <input type="password" id="signUpConfirmPassword" placeholder="Confirm Password" required style="margin-top: 16px;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 16px;">
                        <input type="checkbox" id="enable2FA" style="width: auto;">
                        <label for="enable2FA" style="color: #8696a0; font-size: 14px;">Enable Two-Factor Authentication</label>
                    </div>
                    <div class="step-navigation">
                        <button class="step-btn back" onclick="goToStep(2)"><i class="fas fa-arrow-left"></i> Back</button>
                        <button class="step-btn next" onclick="goToStep(4)">Next <i class="fas fa-arrow-right"></i></button>
                    </div>
                </div>
                
                <!-- Step 4: Review -->
                <div class="step-content" id="stepContent4">
                    <h3 style="color: #00a884; margin-bottom: 20px; text-align: center;">Review & Complete</h3>
                    
                    <div class="review-info" id="signupReview">
                        <div style="text-align: center; margin-bottom: 20px;">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Alex" alt="Avatar" class="avatar-preview" id="reviewAvatar" style="width: 80px; height: 80px;">
                        </div>
                        <div id="reviewContent">
                            <!-- Review content will be populated here -->
                        </div>
                    </div>
                    
                    <div class="terms-checkbox">
                        <input type="checkbox" id="acceptTerms" required>
                        <label for="acceptTerms">
                            I agree to the <a href="#" onclick="showTerms()">Terms of Service</a> and <a href="#" onclick="showPrivacy()">Privacy Policy</a>
                        </label>
                    </div>
                    
                    <div class="step-navigation">
                        <button class="step-btn back" onclick="goToStep(3)"><i class="fas fa-arrow-left"></i> Back</button>
                        <button class="step-btn submit" onclick="completeSignup()" id="completeSignupBtn">
                            <i class="fas fa-user-plus"></i> Create Account
                        </button>
                    </div>
                </div>
                
                <p class="auth-toggle" style="margin-top: 20px;">Already have an account? <span onclick="showLogin()">Sign In</span></p>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm" style="display: none;">
                <input type="email" id="loginEmail" placeholder="Email" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="rememberMe" style="width: auto;">
                        <label for="rememberMe" style="color: #8696a0; font-size: 14px;">Remember me</label>
                    </div>
                    <a href="#" onclick="showForgotPassword()" style="color: #00a884; font-size: 14px; text-decoration: none;">Forgot password?</a>
                </div>
                <button onclick="signIn()" id="loginBtn">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
                <div style="text-align: center; margin: 20px 0; position: relative;">
                    <div style="height: 1px; background: #2a3942; position: absolute; top: 50%; left: 0; right: 0;"></div>
                    <span style="background: #111b21; padding: 0 10px; color: #8696a0; font-size: 14px; position: relative;">OR</span>
                </div>
                <button onclick="signInWithGoogle()" style="width: 100%; padding: 14px; background: #2a3942; color: #e9edef; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-bottom: 10px;">
                    <i class="fab fa-google" style="margin-right: 10px;"></i> Sign in with Google
                </button>
                <p class="auth-toggle">Don't have an account? <span onclick="showSignUp()">Sign Up</span></p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="header">
                <div class="user-info">
                    <img src="" alt="Avatar" class="user-avatar" id="userAvatar" onclick="toggleDropdown()">
                    <div>
                        <div class="user-name" id="userName"></div>
                        <div class="user-status" id="userStatus">Online</div>
                    </div>
                </div>
                <div class="header-icons">
                    <!-- Moved settings icon here from â‹® -->
                    <i class="fas fa-cog" onclick="showSettingsModal()" title="Settings"></i>
                </div>
                
                <!-- Dropdown Menu -->
                <div class="dropdown-menu" id="dropdownMenu">
                    <div class="dropdown-item profile" onclick="showProfileModal()">
                        <i class="fas fa-user-edit"></i>
                        <span>Edit Profile</span>
                    </div>
                    <div class="dropdown-item" onclick="showSettingsModal()">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="toggleTheme()">
                        <i class="fas fa-moon"></i>
                        <span>Dark Mode</span>
                        <div style="flex: 1;"></div>
                        <div class="toggle-switch" style="transform: scale(0.8);">
                            <input type="checkbox" id="themeToggle" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="dropdown-item" onclick="toggleNotifications()">
                        <i class="fas fa-bell"></i>
                        <span>Notifications</span>
                        <div style="flex: 1;"></div>
                        <div class="toggle-switch" style="transform: scale(0.8);">
                            <input type="checkbox" id="notificationsToggle" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="showPrivacySettings()">
                        <i class="fas fa-shield-alt"></i>
                        <span>Privacy & Security</span>
                    </div>
                    <div class="dropdown-item" onclick="showHelp()">
                        <i class="fas fa-question-circle"></i>
                        <span>Help & Support</span>
                    </div>
                    <div class="dropdown-item" onclick="showAbout()">
                        <i class="fas fa-info-circle"></i>
                        <span>About Flow Chat</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item logout" onclick="signOut()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </div>
                </div>
            </div>
            
            <div class="search-container" id="searchContainer">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search chats or users..." oninput="debouncedSearch()">
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="switchTab('chats')">CHATS</div>
                <div class="tab" onclick="switchTab('users')">USERS</div>
            </div>
            
            <!-- Chats List -->
            <div class="chat-list" id="chatsList">
                <!-- Chats will be loaded here -->
            </div>
            
            <!-- Users List -->
            <div class="users-list" id="usersList">
                <!-- Users will be loaded here -->
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area" id="chatArea">
            <div class="chat-header-main">
                <button class="back-button" onclick="showSidebar()">
                    <i class="fas fa-arrow-left"></i>
                </button>
                <div class="chat-partner-info">
                    <img src="" alt="Avatar" class="chat-avatar" id="chatPartnerAvatar">
                    <div>
                        <div class="user-name" id="chatPartnerName">Select a chat</div>
                        <div class="typing-indicator" id="typingIndicator">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                            typing...
                        </div>
                        <div class="user-status" id="chatPartnerStatus">Last seen today at 10:30</div>
                    </div>
                </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <!-- Messages will be loaded here -->
            </div>
            
            <div class="message-input-container" id="messageInputArea" style="display: none;">
                <div class="input-icons">
                    <i class="fas fa-plus-circle" onclick="showAttachmentOptions()"></i>
                    <i class="fas fa-smile" onclick="showEmojiPicker()"></i>
                </div>
                <div class="message-input-wrapper">
                    <textarea class="message-input" id="messageInput" placeholder="Type a message" rows="1" 
                              onkeydown="handleInputKeydown(event)" 
                              oninput="autoResize(this); handleTyping()"></textarea>
                </div>
                <button class="send-button" id="sendButton" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="profile-modal" id="profileModal">
        <div class="profile-content">
            <div class="profile-header">
                <h2>Edit Profile</h2>
                <button class="close-btn" onclick="hideProfileModal()">Ã—</button>
            </div>
            <div class="profile-body">
                <div class="form-group">
                    <label>Profile Picture</label>
                    <div class="avatar-options" id="avatarOptions">
                        <!-- Avatars will be loaded here -->
                    </div>
                    <div style="margin-top: 10px;">
                        <input type="text" id="customAvatarUrl" placeholder="Or enter custom image URL" 
                               style="width: 100%; padding: 8px; margin-top: 5px;">
                        <button onclick="addCustomAvatar()" style="margin-top: 5px; padding: 8px 12px; background: #2a3942; color: #e9edef; border: none; border-radius: 6px; cursor: pointer;">
                            Add Custom Avatar
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="profileName" placeholder="Enter your name">
                </div>
                
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="profileUsername" placeholder="Enter username">
                    <div style="font-size: 12px; color: #8696a0; margin-top: 5px;">
                        This will be used for searching your profile
                    </div>
                </div>
                
                <div class="form-group">
                    <label>About</label>
                    <textarea id="profileAbout" placeholder="Tell something about yourself"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Gender</label>
                    <select id="profileGender">
                        <option value="">Select Gender</option>
                        <option value="male">Male</option>
                        <option value="female">Female</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="profileEmail" disabled style="background: #3a4a52;">
                </div>
                
                <div class="form-group">
                    <label>Change Password</label>
                    <div class="info-message" style="margin-bottom: 15px;">
                        <i class="fas fa-info-circle"></i> Leave password fields empty if you don't want to change
                    </div>
                    <input type="password" id="newPassword" placeholder="New password">
                    <input type="password" id="confirmPassword" placeholder="Confirm new password" style="margin-top: 8px;">
                </div>
                
                <div class="profile-actions">
                    <button class="save-btn" onclick="updateProfile()" id="saveProfileBtn">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                    <button class="cancel-btn" onclick="hideProfileModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button class="logout-btn" onclick="signOut()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal - Complete with all sections -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <h2><i class="fas fa-cog"></i> Settings</h2>
                <button class="close-btn" onclick="hideSettingsModal()">Ã—</button>
            </div>
            <div class="settings-body" id="settingsBody">
                <!-- Account Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-user-circle"></i> Account</h3>
                    
                    <div class="settings-item" onclick="showPersonalInformation()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-user-edit"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Personal Information</div>
                                <div class="settings-item-desc">View/edit name, birth date, gender</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showContactInfo()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-address-book"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Contact Info</div>
                                <div class="settings-item-desc">Add/remove email, phone number</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showIdentityConfirmation()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-id-card"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Identity Confirmation</div>
                                <div class="settings-item-desc">ID verification</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showAccountDeactivation()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-user-slash"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Deactivation or Deletion</div>
                                <div class="settings-item-desc">Temporarily disable or permanently delete account</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Security & Login Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-shield-alt"></i> Security & Login</h3>
                    
                    <div class="settings-item" onclick="showChangePassword()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-key"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Change Password</div>
                                <div class="settings-item-desc">Update your account password</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showActiveSessions()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-laptop"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Where You're Logged In</div>
                                <div class="settings-item-desc">See which devices have active sessions</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <span class="badge" id="activeSessionsCount">0</span>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-bell"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Login Alerts</div>
                                <div class="settings-item-desc">Notifications for new logins</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <div class="toggle-switch">
                                <input type="checkbox" id="loginAlertsToggle" checked>
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showTwoFactorAuth()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Two-Factor Authentication</div>
                                <div class="settings-item-desc">Add extra security to your account</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showAuthorizedLogins()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Authorized Logins</div>
                                <div class="settings-item-desc">Apps/devices with permission</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showAdvancedSecurity()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-shield-virus"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Advanced Security</div>
                                <div class="settings-item-desc">Suspicious activity protection</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Privacy Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-lock"></i> Privacy</h3>
                    
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-eye"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Who Can See Your Future Posts</div>
                                <div class="settings-item-desc">Control post visibility</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <select id="postVisibility" style="background: transparent; border: none; color: #00a884; font-size: 14px;">
                                <option value="public">Public</option>
                                <option value="friends">Friends Only</option>
                                <option value="private">Only Me</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showTagReview()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-tag"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Review Posts You're Tagged In</div>
                                <div class="settings-item-desc">Review tags before they appear</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <div class="toggle-switch">
                                <input type="checkbox" id="tagReviewToggle">
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-user-plus"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Who Can Send You Friend Requests</div>
                                <div class="settings-item-desc">Control friend request settings</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <select id="friendRequests" style="background: transparent; border: none; color: #00a884; font-size: 14px;">
                                <option value="everyone">Everyone</option>
                                <option value="friends_of_friends">Friends of Friends</option>
                                <option value="nobody">Nobody</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Who Can Look You Up</div>
                                <div class="settings-item-desc">Search by phone/email</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <select id="searchVisibility" style="background: transparent; border: none; color: #00a884; font-size: 14px;">
                                <option value="everyone">Everyone</option>
                                <option value="friends">Friends Only</option>
                                <option value="nobody">Nobody</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-globe"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Search Engine Linking</div>
                                <div class="settings-item-desc">Show profile on Google</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <div class="toggle-switch">
                                <input type="checkbox" id="searchEngineToggle">
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Blocking Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-ban"></i> Blocking</h3>
                    
                    <div class="settings-item" onclick="showBlockedUsers()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-user-times"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Block Users</div>
                                <div class="settings-item-desc">Manage blocked users list</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <span class="badge" id="blockedUsersCount">0</span>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showMessageBlocking()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-comment-slash"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Block Messages</div>
                                <div class="settings-item-desc">Block messages from specific users</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-share-square"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Block App Invites</div>
                                <div class="settings-item-desc">Block app invitations</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <div class="toggle-switch">
                                <input type="checkbox" id="appInvitesToggle">
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showPageBlocking()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Block Pages</div>
                                <div class="settings-item-desc">Block specific pages</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Notifications Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-bell"></i> Notifications</h3>
                    
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Push Notifications</div>
                                <div class="settings-item-desc">Mobile notifications</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <div class="toggle-switch">
                                <input type="checkbox" id="pushNotificationsToggle" checked>
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Email Notifications</div>
                                <div class="settings-item-desc">Email notifications</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <div class="toggle-switch">
                                <input type="checkbox" id="emailNotificationsToggle">
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-sms"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">SMS Notifications</div>
                                <div class="settings-item-desc">SMS notifications</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <div class="toggle-switch">
                                <input type="checkbox" id="smsNotificationsToggle">
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-item">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-volume-up"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Notification Sounds</div>
                                <div class="settings-item-desc">Sound on/off</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <div class="toggle-switch">
                                <input type="checkbox" id="notificationSoundToggle" checked>
                                <span class="toggle-slider"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Your Information Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-database"></i> Your Information</h3>
                    
                    <div class="settings-item" onclick="showActivityLog()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Activity Log</div>
                                <div class="settings-item-desc">All activity history</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showDownloadInfo()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Download Your Information</div>
                                <div class="settings-item-desc">Download your data</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showOffAppActivity()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-external-link-alt"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Off-FlowChat Activity</div>
                                <div class="settings-item-desc">Data from other apps</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showDataTransfer()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Transfer Information</div>
                                <div class="settings-item-desc">Transfer data to other services</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Memorialization Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-memory"></i> Memorialization</h3>
                    
                    <div class="settings-item" onclick="showLegacyContact()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-user-friends"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Legacy Contact</div>
                                <div class="settings-item-desc">Control account after passing</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showMemorializeAccount()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-ribbon"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Memorialize Account</div>
                                <div class="settings-item-desc">Account as memorial</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Help & Support Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-question-circle"></i> Help & Support</h3>
                    
                    <div class="settings-item" onclick="showHelpCenter()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-question"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Help Center</div>
                                <div class="settings-item-desc">Help articles</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showSupportInbox()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-inbox"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Support Inbox</div>
                                <div class="settings-item-desc">Report status</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                    
                    <div class="settings-item" onclick="showReportProblem()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Report a Problem</div>
                                <div class="settings-item-desc">Report issues</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Download Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-download"></i> Download</h3>
                    
                    <div class="settings-item" onclick="downloadPWA()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Download PWA/App</div>
                                <div class="settings-item-desc">Install FlowChat as app</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-download"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Logout Section -->
                <div class="settings-section">
                    <h3><i class="fas fa-sign-out-alt"></i> Account</h3>
                    
                    <div class="settings-item" onclick="signOut()">
                        <div class="settings-item-content">
                            <div class="settings-item-icon" style="background: #f15c6d; color: white;">
                                <i class="fas fa-sign-out-alt"></i>
                            </div>
                            <div class="settings-item-text">
                                <div class="settings-item-title">Logout</div>
                                <div class="settings-item-desc">Logout from your account</div>
                            </div>
                        </div>
                        <div class="settings-item-action">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sub Settings Modals -->
    <div class="sub-settings-modal" id="subSettingsModal">
        <div class="sub-settings-content" id="subSettingsContent">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="delete-confirmation" id="deleteConfirmation">
        <div class="delete-modal">
            <div class="delete-header">
                <i class="fas fa-trash-alt" style="font-size: 40px; color: #f15c6d; margin-bottom: 10px;"></i>
                <h3 style="color: #e9edef;">Delete Message</h3>
            </div>
            <div class="delete-body" id="deleteMessageText">
                Are you sure you want to delete this message?
            </div>
            <div class="delete-actions">
                <button class="delete-btn" onclick="cancelDelete()">Cancel</button>
                <button class="delete-btn delete" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // ==============================
        // CONFIGURATION & INITIALIZATION
        // ==============================
        
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDz4_d-NU_fLDsaAMBwnJVPuzoaxqCp-VY",
            authDomain: "flow-d0eb2.firebaseapp.com",
            projectId: "flow-d0eb2",
            storageBucket: "flow-d0eb2.firebasestorage.app",
            messagingSenderId: "489057415403",
            appId: "1:489057415403:web:a96ff07768596644c70eae",
            measurementId: "G-N0HXLKSED2"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const FieldValue = firebase.firestore.FieldValue;

        // App State Management
        const AppState = {
            currentUser: null,
            selectedChatId: null,
            selectedUserId: null,
            currentTab: 'chats',
            allUsers: [],
            userChats: [],
            typingTimeout: null,
            messageToDelete: null,
            longPressTimer: null,
            deferredPrompt: null,
            searchDebounceTimer: null,
            activeListeners: [],
            pageSize: 20,
            lastVisibleMessage: null,
            hasMoreMessages: true,
            isTyping: false,
            isOnline: true,
            userProfileData: null,
            currentStep: 1,
            totalSteps: 4,
            signupData: {
                step1: {},
                step2: {},
                step3: {},
                step4: {}
            },
            displayedMessageIds: new Set(),
            blockedUsers: [],
            activeSessions: [],
            settings: {
                privacy: {
                    postVisibility: 'public',
                    tagReview: false,
                    friendRequests: 'everyone',
                    searchVisibility: 'everyone',
                    searchEngineLinking: false
                },
                notifications: {
                    push: true,
                    email: false,
                    sms: false,
                    sound: true,
                    loginAlerts: true
                },
                blocking: {
                    appInvites: false
                }
            }
        };

        // Default avatar options
        const defaultAvatarOptions = [
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Alex",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Jamie",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Taylor",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Jordan",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Casey",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Riley",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Quinn",
            "https://api.dicebear.com/7.x/avataaars/svg?seed=Dakota"
        ];

        // Country Data with Flags
        const countries = [
            ["Afghanistan", "+93", "af"],
            ["Albania", "+355", "al"],
            ["Algeria", "+213", "dz"],
            ["Andorra", "+376", "ad"],
            ["Angola", "+244", "ao"],
            ["Antigua and Barbuda", "+1", "ag"],
            ["Argentina", "+54", "ar"],
            ["Armenia", "+374", "am"],
            ["Australia", "+61", "au"],
            ["Austria", "+43", "at"],
            ["Azerbaijan", "+994", "az"],
            ["Bahamas", "+1", "bs"],
            ["Bahrain", "+973", "bh"],
            ["Bangladesh", "+880", "bd"],
            ["Barbados", "+1", "bb"],
            ["Belarus", "+375", "by"],
            ["Belgium", "+32", "be"],
            ["Belize", "+501", "bz"],
            ["Benin", "+229", "bj"],
            ["Bhutan", "+975", "bt"],
            ["Bolivia", "+591", "bo"],
            ["Bosnia and Herzegovina", "+387", "ba"],
            ["Botswana", "+267", "bw"],
            ["Brazil", "+55", "br"],
            ["Brunei", "+673", "bn"],
            ["Bulgaria", "+359", "bg"],
            ["Burkina Faso", "+226", "bf"],
            ["Burundi", "+257", "bi"],
            ["Cambodia", "+855", "kh"],
            ["Cameroon", "+237", "cm"],
            ["Canada", "+1", "ca"],
            ["Cape Verde", "+238", "cv"],
            ["Central African Republic", "+236", "cf"],
            ["Chad", "+235", "td"],
            ["Chile", "+56", "cl"],
            ["China", "+86", "cn"],
            ["Colombia", "+57", "co"],
            ["Comoros", "+269", "km"],
            ["Congo", "+242", "cg"],
            ["Costa Rica", "+506", "cr"],
            ["Croatia", "+385", "hr"],
            ["Cuba", "+53", "cu"],
            ["Cyprus", "+357", "cy"],
            ["Czech Republic", "+420", "cz"],
            ["Democratic Republic of the Congo", "+243", "cd"],
            ["Denmark", "+45", "dk"],
            ["Djibouti", "+253", "dj"],
            ["Dominica", "+1", "dm"],
            ["Dominican Republic", "+1", "do"],
            ["Ecuador", "+593", "ec"],
            ["Egypt", "+20", "eg"],
            ["El Salvador", "+503", "sv"],
            ["Equatorial Guinea", "+240", "gq"],
            ["Eritrea", "+291", "er"],
            ["Estonia", "+372", "ee"],
            ["Eswatini", "+268", "sz"],
            ["Ethiopia", "+251", "et"],
            ["Fiji", "+679", "fj"],
            ["Finland", "+358", "fi"],
            ["France", "+33", "fr"],
            ["Gabon", "+241", "ga"],
            ["Gambia", "+220", "gm"],
            ["Georgia", "+995", "ge"],
            ["Germany", "+49", "de"],
            ["Ghana", "+233", "gh"],
            ["Greece", "+30", "gr"],
            ["Grenada", "+1", "gd"],
            ["Guatemala", "+502", "gt"],
            ["Guinea", "+224", "gn"],
            ["Guinea-Bissau", "+245", "gw"],
            ["Guyana", "+592", "gy"],
            ["Haiti", "+509", "ht"],
            ["Honduras", "+504", "hn"],
            ["Hungary", "+36", "hu"],
            ["Iceland", "+354", "is"],
            ["India", "+91", "in"],
            ["Indonesia", "+62", "id"],
            ["Iran", "+98", "ir"],
            ["Iraq", "+964", "iq"],
            ["Ireland", "+353", "ie"],
            ["Israel", "+972", "il"],
            ["Italy", "+39", "it"],
            ["Ivory Coast", "+225", "ci"],
            ["Jamaica", "+1", "jm"],
            ["Japan", "+81", "jp"],
            ["Jordan", "+962", "jo"],
            ["Kazakhstan", "+7", "kz"],
            ["Kenya", "+254", "ke"],
            ["Kiribati", "+686", "ki"],
            ["Kosovo", "+383", "xk"],
            ["Kuwait", "+965", "kw"],
            ["Kyrgyzstan", "+996", "kg"],
            ["Laos", "+856", "la"],
            ["Latvia", "+371", "lv"],
            ["Lebanon", "+961", "lb"],
            ["Lesotho", "+266", "ls"],
            ["Liberia", "+231", "lr"],
            ["Libya", "+218", "ly"],
            ["Liechtenstein", "+423", "li"],
            ["Lithuania", "+370", "lt"],
            ["Luxembourg", "+352", "lu"],
            ["Madagascar", "+261", "mg"],
            ["Malawi", "+265", "mw"],
            ["Malaysia", "+60", "my"],
            ["Maldives", "+960", "mv"],
            ["Mali", "+223", "ml"],
            ["Malta", "+356", "mt"],
            ["Marshall Islands", "+692", "mh"],
            ["Mauritania", "+222", "mr"],
            ["Mauritius", "+230", "mu"],
            ["Mexico", "+52", "mx"],
            ["Micronesia", "+691", "fm"],
            ["Moldova", "+373", "md"],
            ["Monaco", "+377", "mc"],
            ["Mongolia", "+976", "mn"],
            ["Montenegro", "+382", "me"],
            ["Morocco", "+212", "ma"],
            ["Mozambique", "+258", "mz"],
            ["Myanmar", "+95", "mm"],
            ["Namibia", "+264", "na"],
            ["Nauru", "+674", "nr"],
            ["Nepal", "+977", "np"],
            ["Netherlands", "+31", "nl"],
            ["New Zealand", "+64", "nz"],
            ["Nicaragua", "+505", "ni"],
            ["Niger", "+227", "ne"],
            ["Nigeria", "+234", "ng"],
            ["North Korea", "+850", "kp"],
            ["North Macedonia", "+389", "mk"],
            ["Norway", "+47", "no"],
            ["Oman", "+968", "om"],
            ["Pakistan", "+92", "pk"],
            ["Palau", "+680", "pw"],
            ["Palestine", "+970", "ps"],
            ["Panama", "+507", "pa"],
            ["Papua New Guinea", "+675", "pg"],
            ["Paraguay", "+595", "py"],
            ["Peru", "+51", "pe"],
            ["Philippines", "+63", "ph"],
            ["Poland", "+48", "pl"],
            ["Portugal", "+351", "pt"],
            ["Qatar", "+974", "qa"],
            ["Romania", "+40", "ro"],
            ["Russia", "+7", "ru"],
            ["Rwanda", "+250", "rw"],
            ["Saint Kitts and Nevis", "+1", "kn"],
            ["Saint Lucia", "+1", "lc"],
            ["Saint Vincent and the Grenadines", "+1", "vc"],
            ["Samoa", "+685", "ws"],
            ["San Marino", "+378", "sm"],
            ["Sao Tome and Principe", "+239", "st"],
            ["Saudi Arabia", "+966", "sa"],
            ["Senegal", "+221", "sn"],
            ["Serbia", "+381", "rs"],
            ["Seychelles", "+248", "sc"],
            ["Sierra Leone", "+232", "sl"],
            ["Singapore", "+65", "sg"],
            ["Slovakia", "+421", "sk"],
            ["Slovenia", "+386", "si"],
            ["Solomon Islands", "+677", "sb"],
            ["Somalia", "+252", "so"],
            ["South Africa", "+27", "za"],
            ["South Korea", "+82", "kr"],
            ["South Sudan", "+211", "ss"],
            ["Spain", "+34", "es"],
            ["Sri Lanka", "+94", "lk"],
            ["Sudan", "+249", "sd"],
            ["Suriname", "+597", "sr"],
            ["Sweden", "+46", "se"],
            ["Switzerland", "+41", "ch"],
            ["Syria", "+963", "sy"],
            ["Taiwan", "+886", "tw"],
            ["Tajikistan", "+992", "tj"],
            ["Tanzania", "+255", "tz"],
            ["Thailand", "+66", "th"],
            ["Timor-Leste", "+670", "tl"],
            ["Togo", "+228", "tg"],
            ["Tonga", "+676", "to"],
            ["Trinidad and Tobago", "+1", "tt"],
            ["Tunisia", "+216", "tn"],
            ["Turkey", "+90", "tr"],
            ["Turkmenistan", "+993", "tm"],
            ["Tuvalu", "+688", "tv"],
            ["Uganda", "+256", "ug"],
            ["Ukraine", "+380", "ua"],
            ["United Arab Emirates", "+971", "ae"],
            ["United Kingdom", "+44", "gb"],
            ["United States", "+1", "us"],
            ["Uruguay", "+598", "uy"],
            ["Uzbekistan", "+998", "uz"],
            ["Vanuatu", "+678", "vu"],
            ["Vatican City", "+39", "va"],
            ["Venezuela", "+58", "ve"],
            ["Vietnam", "+84", "vn"],
            ["Yemen", "+967", "ye"],
            ["Zambia", "+260", "zm"],
            ["Zimbabwe", "+263", "zw"]
        ];

        // ==============================
        // UTILITY FUNCTIONS
        // ==============================

        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        function showLoader(button) {
            const originalText = button.innerHTML;
            button.innerHTML = '<div class="loading-spinner"></div>';
            button.disabled = true;
            return originalText;
        }

        function hideLoader(button, originalText) {
            button.innerHTML = originalText;
            button.disabled = false;
        }

        function debounce(func, wait) {
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(AppState.searchDebounceTimer);
                    func(...args);
                };
                clearTimeout(AppState.searchDebounceTimer);
                AppState.searchDebounceTimer = setTimeout(later, wait);
            };
        }

        function formatTime(timestamp) {
            if (!timestamp) return '';
            
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m`;
                
                if (date.toDateString() === now.toDateString()) {
                    return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
                
                return date.toLocaleDateString([], { month: 'short', day: 'numeric' });
            } catch (error) {
                console.error('Error formatting time:', error);
                return '';
            }
        }

        function formatMessageTime(timestamp) {
            if (!timestamp) return '';
            
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } catch (error) {
                console.error('Error formatting message time:', error);
                return '';
            }
        }

        function formatDate(date) {
            try {
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (date.toDateString() === today.toDateString()) {
                    return 'Today';
                } else if (date.toDateString() === yesterday.toDateString()) {
                    return 'Yesterday';
                } else {
                    return date.toLocaleDateString([], { 
                        weekday: 'long', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                }
            } catch (error) {
                console.error('Error formatting date:', error);
                return '';
            }
        }

        function formatLastSeen(timestamp) {
            if (!timestamp) return 'recently';
            
            try {
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                
                if (diffMins < 1) return 'just now';
                if (diffMins < 60) return `${diffMins} minutes ago`;
                
                const diffHours = Math.floor(diffMins / 60);
                if (diffHours < 24) return `${diffHours} hours ago`;
                
                if (date.toDateString() === now.toDateString()) {
                    return 'today at ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
                
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                if (date.toDateString() === yesterday.toDateString()) {
                    return 'yesterday at ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
                
                return date.toLocaleDateString([], { 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit'
                });
            } catch (error) {
                console.error('Error formatting last seen:', error);
                return 'recently';
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 100) + 'px';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function isValidEmail(email) {
            const re = /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
            return re.test(String(email).toLowerCase());
        }

        // ==============================
        // PWA FUNCTIONS
        // ==============================

        function setupPWA() {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                AppState.deferredPrompt = e;
                
                setTimeout(() => {
                    if (AppState.deferredPrompt) {
                        showInstallPrompt();
                    }
                }, 3000);
            });
            
            window.addEventListener('appinstalled', () => {
                AppState.deferredPrompt = null;
                hideInstallPrompt();
            });
        }

        function setupManifest() {
            const manifest = {
                "name": "Flow Chat",
                "short_name": "Flow Chat",
                "description": "Professional messaging app",
                "start_url": "/",
                "display": "standalone",
                "background_color": "#0c1317",
                "theme_color": "#00a884",
                "icons": [
                    {
                        "src": "https://i.postimg.cc/ykFG8kvt/file-00000000272471fab8835c85a3b23385-edit-177154342593200.png",
                        "sizes": "192x192",
                        "type": "image/svg+xml"
                    },
                    {
                        "src": "https://i.postimg.cc/ykFG8kvt/file-00000000272471fab8835c85a3b23385-edit-177154342593200.png",
                        "sizes": "512x512",
                        "type": "image/svg+xml"
                    }
                ]
            };
            
            const manifestString = JSON.stringify(manifest);
            const manifestBlob = new Blob([manifestString], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(manifestBlob);
            
            document.getElementById('manifest').href = manifestURL;
        }

        function showInstallPrompt() {
            const installPrompt = document.getElementById('installPrompt');
            installPrompt.style.display = 'flex';
            
            setTimeout(() => {
                installPrompt.style.display = 'none';
            }, 10000);
        }

        function hideInstallPrompt() {
            document.getElementById('installPrompt').style.display = 'none';
        }

        async function installApp() {
            if (AppState.deferredPrompt) {
                AppState.deferredPrompt.prompt();
                const { outcome } = await AppState.deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    AppState.deferredPrompt = null;
                }
            }
        }

        // ==============================
        // SETTINGS MODAL FUNCTIONS
        // ==============================

        function showSettingsModal() {
            document.getElementById('settingsModal').style.display = 'flex';
            loadSettingsData();
        }

        function hideSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
            hideSubSettingsModal();
        }

        function showSubSettingsModal(title, content) {
            const subSettingsContent = document.getElementById('subSettingsContent');
            subSettingsContent.innerHTML = `
                <div class="sub-settings-header">
                    <h3>${title}</h3>
                    <button class="close-btn" onclick="hideSubSettingsModal()">Ã—</button>
                </div>
                <div class="sub-settings-body">
                    ${content}
                </div>
            `;
            document.getElementById('subSettingsModal').style.display = 'flex';
        }

        function hideSubSettingsModal() {
            document.getElementById('subSettingsModal').style.display = 'none';
        }

        function loadSettingsData() {
            // Load privacy settings
            document.getElementById('postVisibility').value = AppState.settings.privacy.postVisibility;
            document.getElementById('tagReviewToggle').checked = AppState.settings.privacy.tagReview;
            document.getElementById('friendRequests').value = AppState.settings.privacy.friendRequests;
            document.getElementById('searchVisibility').value = AppState.settings.privacy.searchVisibility;
            document.getElementById('searchEngineToggle').checked = AppState.settings.privacy.searchEngineLinking;
            
            // Load notification settings
            document.getElementById('pushNotificationsToggle').checked = AppState.settings.notifications.push;
            document.getElementById('emailNotificationsToggle').checked = AppState.settings.notifications.email;
            document.getElementById('smsNotificationsToggle').checked = AppState.settings.notifications.sms;
            document.getElementById('notificationSoundToggle').checked = AppState.settings.notifications.sound;
            document.getElementById('loginAlertsToggle').checked = AppState.settings.notifications.loginAlerts;
            
            // Load blocking settings
            document.getElementById('appInvitesToggle').checked = AppState.settings.blocking.appInvites;
            
            // Update counts
            document.getElementById('blockedUsersCount').textContent = AppState.blockedUsers.length;
            document.getElementById('activeSessionsCount').textContent = AppState.activeSessions.length;
        }

        // ==============================
        // SETTINGS SECTION FUNCTIONS
        // ==============================

        // Account Section
        function showPersonalInformation() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-user-edit"></i> Personal Information</h4>
                    <div class="sub-settings-item">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Full Name</div>
                            <div class="sub-settings-item-desc">${AppState.userProfileData?.name || 'Not set'}</div>
                        </div>
                        <button class="text-button" onclick="editPersonalInfo('name')">Edit</button>
                    </div>
                    <div class="sub-settings-item">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Date of Birth</div>
                            <div class="sub-settings-item-desc">Not set</div>
                        </div>
                        <button class="text-button" onclick="editPersonalInfo('birthdate')">Edit</button>
                    </div>
                    <div class="sub-settings-item">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Gender</div>
                            <div class="sub-settings-item-desc">${AppState.userProfileData?.gender || 'Not set'}</div>
                        </div>
                        <button class="text-button" onclick="editPersonalInfo('gender')">Edit</button>
                    </div>
                </div>
            `;
            showSubSettingsModal('Personal Information', content);
        }

        function showContactInfo() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-address-book"></i> Contact Information</h4>
                    <div class="sub-settings-item">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Email Address</div>
                            <div class="sub-settings-item-desc">${AppState.userProfileData?.email || 'Not set'}</div>
                        </div>
                        <button class="text-button" onclick="editContactInfo('email')">Edit</button>
                    </div>
                    <div class="sub-settings-item">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Phone Number</div>
                            <div class="sub-settings-item-desc">${AppState.userProfileData?.phone || 'Not set'}</div>
                        </div>
                        <button class="text-button" onclick="editContactInfo('phone')">Edit</button>
                    </div>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i> You can add or remove contact information here
                    </div>
                </div>
            `;
            showSubSettingsModal('Contact Information', content);
        }

        function showIdentityConfirmation() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-id-card"></i> Identity Confirmation</h4>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i> Verify your identity for enhanced security
                    </div>
                    <div class="sub-settings-item">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Verification Status</div>
                            <div class="sub-settings-item-desc">Not verified</div>
                        </div>
                        <button class="text-button" onclick="startIdentityVerification()">Verify Now</button>
                    </div>
                    <div style="margin-top: 20px;">
                        <p style="color: #8696a0; font-size: 14px;">
                            Identity verification helps protect your account and enables additional features.
                        </p>
                    </div>
                </div>
            `;
            showSubSettingsModal('Identity Confirmation', content);
        }

        function showAccountDeactivation() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-user-slash"></i> Account Deactivation & Deletion</h4>
                    <div class="info-message">
                        <i class="fas fa-exclamation-triangle"></i> Warning: These actions are permanent
                    </div>
                    <div class="sub-settings-item">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Temporary Deactivation</div>
                            <div class="sub-settings-item-desc">Hide your account temporarily</div>
                        </div>
                        <button class="text-button" onclick="deactivateAccount()">Deactivate</button>
                    </div>
                    <div class="sub-settings-item">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Permanent Deletion</div>
                            <div class="sub-settings-item-desc">Delete your account permanently</div>
                        </div>
                        <button class="danger-button" onclick="deleteAccount()">Delete</button>
                    </div>
                    <div style="margin-top: 20px;">
                        <p style="color: #8696a0; font-size: 14px;">
                            <strong>Deactivation:</strong> Your account will be hidden but can be restored later.<br>
                            <strong>Deletion:</strong> All your data will be permanently deleted and cannot be recovered.
                        </p>
                    </div>
                </div>
            `;
            showSubSettingsModal('Account Deactivation & Deletion', content);
        }

        // Security & Login Section
        function showChangePassword() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-key"></i> Change Password</h4>
                    <div style="margin-bottom: 20px;">
                        <input type="password" id="currentPassword" placeholder="Current Password" style="width: 100%; padding: 12px; margin-bottom: 10px; background: #2a3942; border: 1px solid #3a4a52; border-radius: 8px; color: #e9edef;">
                        <input type="password" id="newPasswordSetting" placeholder="New Password" style="width: 100%; padding: 12px; margin-bottom: 10px; background: #2a3942; border: 1px solid #3a4a52; border-radius: 8px; color: #e9edef;">
                        <input type="password" id="confirmNewPassword" placeholder="Confirm New Password" style="width: 100%; padding: 12px; margin-bottom: 20px; background: #2a3942; border: 1px solid #3a4a52; border-radius: 8px; color: #e9edef;">
                        <button class="text-button" style="width: 100%; padding: 12px; background: #00a884; color: #111b21; border: none; border-radius: 8px; font-weight: 600;" onclick="updatePassword()">Change Password</button>
                    </div>
                </div>
            `;
            showSubSettingsModal('Change Password', content);
        }

        function showActiveSessions() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-laptop"></i> Active Sessions</h4>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i> Currently active login sessions
                    </div>
                    ${AppState.activeSessions.length === 0 ? 
                        '<p style="text-align: center; color: #8696a0; padding: 20px;">No active sessions found</p>' :
                        AppState.activeSessions.map(session => `
                            <div class="sub-settings-item">
                                <div class="sub-settings-item-text">
                                    <div class="sub-settings-item-title">${session.device}</div>
                                    <div class="sub-settings-item-desc">Last active: ${session.lastActive}</div>
                                </div>
                                <button class="danger-button" onclick="logoutSession('${session.id}')">Logout</button>
                            </div>
                        `).join('')
                    }
                    <div style="margin-top: 20px;">
                        <button class="text-button" style="width: 100%;" onclick="logoutAllSessions()">Logout From All Devices</button>
                    </div>
                </div>
            `;
            showSubSettingsModal('Active Sessions', content);
        }

        function showTwoFactorAuth() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-mobile-alt"></i> Two-Factor Authentication</h4>
                    <div class="sub-settings-item">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">2FA Status</div>
                            <div class="sub-settings-item-desc">${AppState.userProfileData?.settings?.twoFactorEnabled ? 'Enabled' : 'Disabled'}</div>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="twoFactorToggle" ${AppState.userProfileData?.settings?.twoFactorEnabled ? 'checked' : ''} onchange="toggleTwoFactorAuth()">
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i> Two-factor authentication adds an extra layer of security to your account
                    </div>
                    <div style="margin-top: 20px;">
                        <p style="color: #8696a0; font-size: 14px;">
                            When enabled, you'll need to enter a verification code from your mobile device when logging in.
                        </p>
                    </div>
                </div>
            `;
            showSubSettingsModal('Two-Factor Authentication', content);
        }

        function showAuthorizedLogins() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-check-circle"></i> Authorized Logins</h4>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i> Apps and devices with login permissions
                    </div>
                    <p style="text-align: center; color: #8696a0; padding: 20px;">
                        No authorized apps or devices
                    </p>
                    <div style="margin-top: 20px;">
                        <button class="text-button" style="width: 100%;" onclick="reviewAuthorizedLogins()">Review All</button>
                    </div>
                </div>
            `;
            showSubSettingsModal('Authorized Logins', content);
        }

        function showAdvancedSecurity() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-shield-virus"></i> Advanced Security</h4>
                    <div class="sub-settings-item">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Suspicious Activity Alerts</div>
                            <div class="sub-settings-item-desc">Get alerts for unusual activity</div>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="suspiciousActivityToggle" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="sub-settings-item">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Login Notifications</div>
                            <div class="sub-settings-item-desc">Notify on new device login</div>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="loginNotificationsToggle" checked>
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i> Enhanced security features to protect your account
                    </div>
                </div>
            `;
            showSubSettingsModal('Advanced Security', content);
        }

        // Privacy Section
        function showTagReview() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-tag"></i> Tag Review</h4>
                    <div class="sub-settings-item">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Review Tags</div>
                            <div class="sub-settings-item-desc">Review tags before they appear on your profile</div>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="tagReviewSettingToggle" ${AppState.settings.privacy.tagReview ? 'checked' : ''} onchange="updateTagReview()">
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <p style="color: #8696a0; font-size: 14px;">
                            When enabled, you must approve tags before they appear on your profile.
                        </p>
                    </div>
                </div>
            `;
            showSubSettingsModal('Tag Review', content);
        }

        // Blocking Section
        function showBlockedUsers() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-user-times"></i> Blocked Users</h4>
                    ${AppState.blockedUsers.length === 0 ? 
                        '<p style="text-align: center; color: #8696a0; padding: 20px;">No blocked users</p>' :
                        AppState.blockedUsers.map(user => `
                            <div class="sub-settings-item">
                                <div class="sub-settings-item-text">
                                    <div class="sub-settings-item-title">${user.name}</div>
                                    <div class="sub-settings-item-desc">Blocked on ${user.blockedDate}</div>
                                </div>
                                <button class="text-button" onclick="unblockUser('${user.id}')">Unblock</button>
                            </div>
                        `).join('')
                    }
                    <div style="margin-top: 20px;">
                        <button class="text-button" style="width: 100%;" onclick="showBlockUserDialog()">Block New User</button>
                    </div>
                </div>
            `;
            showSubSettingsModal('Blocked Users', content);
        }

        function showMessageBlocking() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-comment-slash"></i> Message Blocking</h4>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i> Block messages from specific users
                    </div>
                    <div class="sub-settings-item">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Block Unknown Senders</div>
                            <div class="sub-settings-item-desc">Block messages from users not in your contacts</div>
                        </div>
                        <div class="toggle-switch">
                            <input type="checkbox" id="blockUnknownSendersToggle">
                            <span class="toggle-slider"></span>
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="text-button" style="width: 100%;" onclick="manageMessageBlocking()">Manage Message Filters</button>
                    </div>
                </div>
            `;
            showSubSettingsModal('Message Blocking', content);
        }

        function showPageBlocking() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-flag"></i> Page Blocking</h4>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i> Block specific pages from interacting with you
                    </div>
                    <p style="text-align: center; color: #8696a0; padding: 20px;">
                        No pages blocked
                    </p>
                    <div style="margin-top: 20px;">
                        <button class="text-button" style="width: 100%;" onclick="blockNewPage()">Block a Page</button>
                    </div>
                </div>
            `;
            showSubSettingsModal('Page Blocking', content);
        }

        // Your Information Section
        function showActivityLog() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-history"></i> Activity Log</h4>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i> Your complete activity history
                    </div>
                    <p style="text-align: center; color: #8696a0; padding: 40px;">
                        Activity log feature coming soon
                    </p>
                </div>
            `;
            showSubSettingsModal('Activity Log', content);
        }

        function showDownloadInfo() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-download"></i> Download Your Information</h4>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i> Download a copy of your data
                    </div>
                    <div class="sub-settings-item">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Data Format</div>
                            <div class="sub-settings-item-desc">Choose your preferred format</div>
                        </div>
                        <select style="background: transparent; border: none; color: #00a884; font-size: 14px;">
                            <option>JSON</option>
                            <option>HTML</option>
                            <option>CSV</option>
                        </select>
                    </div>
                    <div class="sub-settings-item">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Date Range</div>
                            <div class="sub-settings-item-desc">Select time period</div>
                        </div>
                        <select style="background: transparent; border: none; color: #00a884; font-size: 14px;">
                            <option>All Time</option>
                            <option>Last Month</option>
                            <option>Last Year</option>
                        </select>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="text-button" style="width: 100%; padding: 12px; background: #00a884; color: #111b21;" onclick="requestDataDownload()">Request Download</button>
                    </div>
                </div>
            `;
            showSubSettingsModal('Download Your Information', content);
        }

        function showOffAppActivity() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-external-link-alt"></i> Off-FlowChat Activity</h4>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i> Data collected from other websites and apps
                    </div>
                    <p style="text-align: center; color: #8696a0; padding: 40px;">
                        No off-app activity data found
                    </p>
                    <div style="margin-top: 20px;">
                        <button class="text-button" style="width: 100%;" onclick="clearOffAppActivity()">Clear All Activity</button>
                    </div>
                </div>
            `;
            showSubSettingsModal('Off-FlowChat Activity', content);
        }

        function showDataTransfer() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-exchange-alt"></i> Transfer Information</h4>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i> Transfer your data to other services
                    </div>
                    <p style="text-align: center; color: #8696a0; padding: 40px;">
                        Data transfer feature coming soon
                    </p>
                </div>
            `;
            showSubSettingsModal('Transfer Information', content);
        }

        // Memorialization Section
        function showLegacyContact() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-user-friends"></i> Legacy Contact</h4>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i> Choose someone to manage your account
                    </div>
                    <p style="text-align: center; color: #8696a0; padding: 20px;">
                        No legacy contact set
                    </p>
                    <div style="margin-top: 20px;">
                        <button class="text-button" style="width: 100%;" onclick="setLegacyContact()">Choose Legacy Contact</button>
                    </div>
                </div>
            `;
            showSubSettingsModal('Legacy Contact', content);
        }

        function showMemorializeAccount() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-ribbon"></i> Memorialize Account</h4>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i> Memorialize your account for remembrance
                    </div>
                    <div style="margin-top: 20px;">
                        <p style="color: #8696a0; font-size: 14px; text-align: center;">
                            Memorialized accounts are a place for friends and family to gather and share memories.
                        </p>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="text-button" style="width: 100%;" onclick="requestMemorialization()">Request Memorialization</button>
                    </div>
                </div>
            `;
            showSubSettingsModal('Memorialize Account', content);
        }

        // Help & Support Section
        function showHelpCenter() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-question"></i> Help Center</h4>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i> Find answers to common questions
                    </div>
                    <div class="sub-settings-item" onclick="showHelpArticle('getting-started')">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Getting Started</div>
                            <div class="sub-settings-item-desc">Learn the basics</div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="sub-settings-item" onclick="showHelpArticle('privacy')">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Privacy & Security</div>
                            <div class="sub-settings-item-desc">Protect your account</div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="sub-settings-item" onclick="showHelpArticle('troubleshooting')">
                        <div class="sub-settings-item-text">
                            <div class="sub-settings-item-title">Troubleshooting</div>
                            <div class="sub-settings-item-desc">Fix common issues</div>
                        </div>
                        <i class="fas fa-chevron-right"></i>
                    </div>
                </div>
            `;
            showSubSettingsModal('Help Center', content);
        }

        function showSupportInbox() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-inbox"></i> Support Inbox</h4>
                    <div class="info-message">
                        <i class="fas fa-info-circle"></i> Check status of your reports
                    </div>
                    <p style="text-align: center; color: #8696a0; padding: 40px;">
                        No support requests
                    </p>
                </div>
            `;
            showSubSettingsModal('Support Inbox', content);
        }

        function showReportProblem() {
            const content = `
                <div class="sub-settings-section">
                    <h4><i class="fas fa-exclamation-triangle"></i> Report a Problem</h4>
                    <div style="margin-bottom: 20px;">
                        <textarea id="problemDescription" placeholder="Describe the problem you're experiencing..." style="width: 100%; padding: 12px; height: 150px; margin-bottom: 10px; background: #2a3942; border: 1px solid #3a4a52; border-radius: 8px; color: #e9edef;"></textarea>
                        <select id="problemType" style="width: 100%; padding: 12px; margin-bottom: 20px; background: #2a3942; border: 1px solid #3a4a52; border-radius: 8px; color: #e9edef;">
                            <option value="">Select problem type</option>
                            <option value="bug">Bug Report</option>
                            <option value="feature">Feature Request</option>
                            <option value="abuse">Abuse Report</option>
                            <option value="other">Other</option>
                        </select>
                        <button class="text-button" style="width: 100%; padding: 12px; background: #00a884; color: #111b21;" onclick="submitProblemReport()">Submit Report</button>
                    </div>
                </div>
            `;
            showSubSettingsModal('Report a Problem', content);
        }

        // Download Section
        function downloadPWA() {
            if (AppState.deferredPrompt) {
                installApp();
            } else {
                showToast('Your browser doesn\'t support PWA installation');
            }
        }

        // ==============================
        // SETTINGS ACTION FUNCTIONS
        // ==============================

        function updateTagReview() {
            const toggle = document.getElementById('tagReviewSettingToggle');
            AppState.settings.privacy.tagReview = toggle.checked;
            showToast(`Tag review ${toggle.checked ? 'enabled' : 'disabled'}`);
        }

        function toggleTwoFactorAuth() {
            const toggle = document.getElementById('twoFactorToggle');
            showToast(`Two-factor authentication ${toggle.checked ? 'enabled' : 'disabled'}`);
        }

        function updatePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPasswordSetting').value;
            const confirmPassword = document.getElementById('confirmNewPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                showToast('Please fill in all password fields');
                return;
            }

            if (newPassword !== confirmPassword) {
                showToast('New passwords do not match');
                return;
            }

            if (newPassword.length < 6) {
                showToast('Password must be at least 6 characters');
                return;
            }

            showToast('Password update request sent');
            hideSubSettingsModal();
        }

        function logoutSession(sessionId) {
            showToast(`Session ${sessionId} logged out`);
            hideSubSettingsModal();
        }

        function logoutAllSessions() {
            showToast('All sessions logged out');
            hideSubSettingsModal();
        }

        function unblockUser(userId) {
            showToast('User unblocked');
            hideSubSettingsModal();
        }

        function requestDataDownload() {
            showToast('Data download requested. You will receive an email when ready.');
            hideSubSettingsModal();
        }

        function submitProblemReport() {
            const description = document.getElementById('problemDescription').value;
            const type = document.getElementById('problemType').value;

            if (!description || !type) {
                showToast('Please fill in all fields');
                return;
            }

            showToast('Problem report submitted successfully');
            hideSubSettingsModal();
        }

        function setLegacyContact() {
            showToast('Legacy contact feature coming soon');
        }

        function requestMemorialization() {
            showToast('Memorialization request feature coming soon');
        }

        function showHelpArticle(article) {
            showToast(`Opening ${article} article...`);
        }

        function deactivateAccount() {
            if (confirm('Are you sure you want to deactivate your account? You can reactivate it later by logging in.')) {
                showToast('Account deactivation requested');
                hideSubSettingsModal();
            }
        }

        function deleteAccount() {
            if (confirm('WARNING: This will permanently delete your account and all data. This action cannot be undone. Are you sure?')) {
                showToast('Account deletion requested');
                hideSubSettingsModal();
            }
        }

        // ==============================
        // COUNTRY CODE FUNCTIONS
        // ==============================

        function initializeCountrySelect() {
            const countrySelect = document.getElementById('signUpCountryCode');
            const countryFlag = document.getElementById('selectedCountryFlag');
            
            countrySelect.innerHTML = '';
            
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select country';
            countrySelect.appendChild(defaultOption);
            
            countries.forEach(country => {
                const [name, code, flagCode] = country;
                const option = document.createElement('option');
                option.value = code;
                option.dataset.flag = flagCode;
                option.dataset.country = name;
                option.innerHTML = `${name} (${code})`;
                countrySelect.appendChild(option);
            });
            
            const defaultCountry = countries.find(c => c[2] === "bd");
            if (defaultCountry) {
                countrySelect.value = defaultCountry[1];
                countryFlag.src = `https://flagcdn.com/20x15/${defaultCountry[2]}.png`;
                countryFlag.alt = defaultCountry[0];
            }
            
            countrySelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const flagCode = selectedOption.dataset.flag;
                const countryName = selectedOption.dataset.country;
                
                if (this.value) {
                    countryFlag.src = `https://flagcdn.com/20x15/${flagCode}.png`;
                    countryFlag.alt = countryName;
                    countryFlag.style.display = 'block';
                } else {
                    countryFlag.style.display = 'none';
                }
            });
            
            document.getElementById('signUpPhone').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                
                if (value.length > 10) {
                    value = value.substring(0, 10);
                }
                
                if (value.length > 6) {
                    value = value.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
                } else if (value.length > 3) {
                    value = value.replace(/(\d{3})(\d{3})/, '$1-$2');
                }
                
                e.target.value = value;
            });
        }

        // ==============================
        // AUTHENTICATION FUNCTIONS
        // ==============================

        function showLogin() {
            document.getElementById('signUpForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            clearError();
        }

        function showSignUp() {
            document.getElementById('signUpForm').style.display = 'block';
            document.getElementById('loginForm').style.display = 'none';
            clearError();
            resetSignupSteps();
        }

        function clearError() {
            document.getElementById('authError').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('authError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // ==============================
        // SIGNUP STEP-BY-STEP SYSTEM
        // ==============================

        function resetSignupSteps() {
            AppState.currentStep = 1;
            AppState.signupData = {
                step1: {},
                step2: {},
                step3: {},
                step4: {}
            };
            updateStepUI();
            document.getElementById('avatarPreview').src = defaultAvatarOptions[0];
        }

        function goToStep(step) {
            if (!validateCurrentStep()) {
                return;
            }
            
            saveCurrentStepData();
            
            AppState.currentStep = step;
            updateStepUI();
        }

        function validateCurrentStep() {
            switch(AppState.currentStep) {
                case 1:
                    const name = document.getElementById('signUpName').value.trim();
                    const email = document.getElementById('signUpEmail').value.trim();
                    const countryCode = document.getElementById('signUpCountryCode').value;
                    const phone = document.getElementById('signUpPhone').value.trim();
                    
                    if (!name) {
                        showError('Please enter your full name');
                        return false;
                    }
                    
                    if (!email) {
                        showError('Please enter your email address');
                        return false;
                    }
                    
                    if (!isValidEmail(email)) {
                        showError('Please enter a valid email address');
                        return false;
                    }
                    
                    if (phone && phone.length < 7) {
                        showError('Please enter a valid phone number');
                        return false;
                    }
                    return true;
                    
                case 2:
                    const username = document.getElementById('signUpUsername').value.trim().toLowerCase();
                    const gender = document.getElementById('signUpGender').value;
                    
                    if (!username) {
                        showError('Please enter a username');
                        return false;
                    }
                    
                    if (username.length < 3) {
                        showError('Username must be at least 3 characters');
                        return false;
                    }
                    
                    if (!/^[a-z0-9_.]+$/.test(username)) {
                        showError('Username can only contain lowercase letters, numbers, dots, and underscores');
                        return false;
                    }
                    
                    if (!gender) {
                        showError('Please select your gender');
                        return false;
                    }
                    return true;
                    
                case 3:
                    const password = document.getElementById('signUpPassword').value;
                    const confirmPassword = document.getElementById('signUpConfirmPassword').value;
                    
                    if (!password) {
                        showError('Please create a password');
                        return false;
                    }
                    
                    if (password.length < 6) {
                        showError('Password must be at least 6 characters');
                        return false;
                    }
                    
                    if (password !== confirmPassword) {
                        showError('Passwords do not match');
                        return false;
                    }
                    return true;
                    
                case 4:
                    if (!document.getElementById('acceptTerms').checked) {
                        showError('You must accept the terms and conditions');
                        return false;
                    }
                    return true;
            }
            return true;
        }

        function saveCurrentStepData() {
            switch(AppState.currentStep) {
                case 1:
                    AppState.signupData.step1 = {
                        name: document.getElementById('signUpName').value.trim(),
                        email: document.getElementById('signUpEmail').value.trim(),
                        phone: document.getElementById('signUpPhone').value.trim(),
                        countryCode: document.getElementById('signUpCountryCode').value,
                        countryFlag: document.getElementById('selectedCountryFlag').src
                    };
                    break;
                case 2:
                    AppState.signupData.step2 = {
                        username: document.getElementById('signUpUsername').value.trim().toLowerCase(),
                        gender: document.getElementById('signUpGender').value,
                        status: document.getElementById('signUpStatus').value,
                        avatar: document.getElementById('avatarPreview').src
                    };
                    break;
                case 3:
                    AppState.signupData.step3 = {
                        password: document.getElementById('signUpPassword').value,
                        enable2FA: document.getElementById('enable2FA').checked
                    };
                    break;
                case 4:
                    AppState.signupData.step4 = {
                        acceptTerms: document.getElementById('acceptTerms').checked
                    };
                    break;
            }
        }

        function updateStepUI() {
            for (let i = 1; i <= AppState.totalSteps; i++) {
                const stepIndicator = document.getElementById(`step${i}`);
                const stepContent = document.getElementById(`stepContent${i}`);
                
                if (i < AppState.currentStep) {
                    stepIndicator.classList.remove('active');
                    stepIndicator.classList.add('completed');
                    stepContent.classList.remove('active');
                } else if (i === AppState.currentStep) {
                    stepIndicator.classList.add('active');
                    stepIndicator.classList.remove('completed');
                    stepContent.classList.add('active');
                } else {
                    stepIndicator.classList.remove('active');
                    stepIndicator.classList.remove('completed');
                    stepContent.classList.remove('active');
                }
            }
            
            const progressPercentage = ((AppState.currentStep - 1) / (AppState.totalSteps - 1)) * 100;
            document.getElementById('signupProgress').style.width = `${progressPercentage}%`;
            
            const connectorPercentage = ((AppState.currentStep - 1) / AppState.totalSteps) * 100;
            document.getElementById('stepConnector').style.width = `${connectorPercentage}%`;
            
            loadStepData();
            
            if (AppState.currentStep === 4) {
                updateSignupReview();
            }
        }

        function loadStepData() {
            switch(AppState.currentStep) {
                case 1:
                    if (AppState.signupData.step1.name) {
                        document.getElementById('signUpName').value = AppState.signupData.step1.name;
                        document.getElementById('signUpEmail').value = AppState.signupData.step1.email;
                        document.getElementById('signUpPhone').value = AppState.signupData.step1.phone;
                        document.getElementById('signUpCountryCode').value = AppState.signupData.step1.countryCode;
                        document.getElementById('selectedCountryFlag').src = AppState.signupData.step1.countryFlag;
                    }
                    break;
                case 2:
                    if (AppState.signupData.step2.username) {
                        document.getElementById('signUpUsername').value = AppState.signupData.step2.username;
                        document.getElementById('signUpGender').value = AppState.signupData.step2.gender;
                        document.getElementById('signUpStatus').value = AppState.signupData.step2.status;
                        document.getElementById('avatarPreview').src = AppState.signupData.step2.avatar;
                    }
                    break;
                case 3:
                    if (AppState.signupData.step3.password) {
                        document.getElementById('signUpPassword').value = AppState.signupData.step3.password;
                        document.getElementById('signUpConfirmPassword').value = AppState.signupData.step3.password;
                        document.getElementById('enable2FA').checked = AppState.signupData.step3.enable2FA;
                        checkPasswordStrength();
                    }
                    break;
                case 4:
                    document.getElementById('acceptTerms').checked = AppState.signupData.step4.acceptTerms || false;
                    break;
            }
        }

        function updateSignupReview() {
            const reviewContainer = document.getElementById('reviewContent');
            let reviewHTML = '';
            
            if (AppState.signupData.step1.name) {
                reviewHTML += `
                    <div class="review-item">
                        <div class="review-label">Name:</div>
                        <div class="review-value">${AppState.signupData.step1.name}</div>
                    </div>
                    <div class="review-item">
                        <div class="review-label">Email:</div>
                        <div class="review-value">${AppState.signupData.step1.email}</div>
                    </div>
                `;
                
                if (AppState.signupData.step1.phone) {
                    reviewHTML += `
                        <div class="review-item">
                            <div class="review-label">Phone:</div>
                            <div class="review-value">${AppState.signupData.step1.countryCode} ${AppState.signupData.step1.phone}</div>
                        </div>
                    `;
                }
            }
            
            if (AppState.signupData.step2.username) {
                reviewHTML += `
                    <div class="review-item">
                        <div class="review-label">Username:</div>
                        <div class="review-value">@${AppState.signupData.step2.username}</div>
                    </div>
                    <div class="review-item">
                        <div class="review-label">Gender:</div>
                        <div class="review-value">${AppState.signupData.step2.gender}</div>
                    </div>
                `;
                
                if (AppState.signupData.step2.status) {
                    reviewHTML += `
                        <div class="review-item">
                            <div class="review-label">Status:</div>
                            <div class="review-value">${AppState.signupData.step2.status}</div>
                        </div>
                    `;
                }
                
                document.getElementById('reviewAvatar').src = AppState.signupData.step2.avatar;
            }
            
            if (AppState.signupData.step3.password) {
                reviewHTML += `
                    <div class="review-item">
                        <div class="review-label">2FA:</div>
                        <div class="review-value">${AppState.signupData.step3.enable2FA ? 'Enabled' : 'Disabled'}</div>
                    </div>
                `;
            }
            
            reviewContainer.innerHTML = reviewHTML;
        }

        async function completeSignup() {
            if (!validateCurrentStep()) {
                return;
            }
            
            saveCurrentStepData();
            
            const completeBtn = document.getElementById('completeSignupBtn');
            const originalText = showLoader(completeBtn);
            
            try {
                const usernameSnapshot = await db.collection('users')
                    .where('username', '==', AppState.signupData.step2.username)
                    .get();
                
                if (!usernameSnapshot.empty) {
                    showError('Username already taken');
                    hideLoader(completeBtn, originalText);
                    return;
                }
                
                const userCredential = await auth.createUserWithEmailAndPassword(
                    AppState.signupData.step1.email, 
                    AppState.signupData.step3.password
                );
                const user = userCredential.user;
                
                await db.collection('users').doc(user.uid).set({
                    uid: user.uid,
                    name: AppState.signupData.step1.name,
                    username: AppState.signupData.step2.username,
                    email: AppState.signupData.step1.email,
                    phone: AppState.signupData.step1.phone ? 
                        `${AppState.signupData.step1.countryCode}${AppState.signupData.step1.phone.replace(/\D/g, '')}` : null,
                    gender: AppState.signupData.step2.gender,
                    status: AppState.signupData.step2.status,
                    photoURL: AppState.signupData.step2.avatar || defaultAvatarOptions[0],
                    about: "Hey there! I'm using Flow Chat",
                    online: true,
                    lastSeen: FieldValue.serverTimestamp(),
                    typingTo: null,
                    createdAt: FieldValue.serverTimestamp(),
                    customAvatars: [],
                    settings: {
                        theme: 'dark',
                        notifications: true,
                        sound: true,
                        vibration: true,
                        lastSeenPrivacy: 'everyone',
                        profilePhotoPrivacy: 'everyone',
                        language: 'en',
                        autoDownload: 'wifi',
                        twoFactorEnabled: AppState.signupData.step3.enable2FA || false,
                        fontSize: 'medium',
                        network: 'standard'
                    }
                });
                
                showToast('Account created successfully!');
                
                await auth.signInWithEmailAndPassword(AppState.signupData.step1.email, AppState.signupData.step3.password);
                
            } catch (error) {
                console.error('Sign up error:', error);
                showError(error.message || 'Failed to create account');
            } finally {
                hideLoader(completeBtn, originalText);
            }
        }

        function checkPasswordStrength() {
            const password = document.getElementById('signUpPassword').value;
            const strengthFill = document.getElementById('passwordStrengthFill');
            const strengthText = document.getElementById('passwordStrengthText');
            
            if (!password) {
                strengthFill.style.width = '0%';
                strengthText.textContent = 'Password strength';
                strengthFill.className = 'strength-fill';
                return;
            }
            
            let strength = 0;
            let text = '';
            let className = '';
            
            if (password.length >= 8) strength += 20;
            if (password.length >= 12) strength += 10;
            
            if (/[a-z]/.test(password)) strength += 15;
            if (/[A-Z]/.test(password)) strength += 15;
            if (/[0-9]/.test(password)) strength += 15;
            if (/[^A-Za-z0-9]/.test(password)) strength += 15;
            
            if (/(.)\1{2,}/.test(password)) strength -= 10;
            if (/^\d+$/.test(password)) strength -= 10;
            if (/^[a-zA-Z]+$/.test(password)) strength -= 10;
            
            strength = Math.max(0, Math.min(100, strength));
            
            if (strength < 30) {
                text = 'Weak';
                className = 'strength-weak';
            } else if (strength < 50) {
                text = 'Fair';
                className = 'strength-fair';
            } else if (strength < 70) {
                text = 'Good';
                className = 'strength-good';
            } else if (strength < 90) {
                text = 'Strong';
                className = 'strength-strong';
            } else {
                text = 'Very Strong';
                className = 'strength-very-strong';
            }
            
            strengthFill.style.width = `${strength}%`;
            strengthFill.className = `strength-fill ${className}`;
            strengthText.textContent = `Password strength: ${text}`;
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showToast('Please select an image file');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showToast('Image size should be less than 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarPreview').src = e.target.result;
                AppState.signupData.step2.avatar = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // ==============================
        // LOGIN FUNCTION
        // ==============================

        async function signIn() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            
            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }
            
            const originalText = showLoader(loginBtn);
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                showToast('Signed in successfully!');
            } catch (error) {
                console.error('Sign in error:', error);
                showError(error.message || 'Invalid email or password');
            } finally {
                hideLoader(loginBtn, originalText);
            }
        }

        // ==============================
        // DROPDOWN FUNCTIONS
        // ==============================

        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
            
            if (dropdown.classList.contains('show')) {
                setTimeout(() => {
                    const closeHandler = (e) => {
                        if (!dropdown.contains(e.target) && !e.target.closest('.header-icons')) {
                            dropdown.classList.remove('show');
                            document.removeEventListener('click', closeHandler);
                        }
                    };
                    document.addEventListener('click', closeHandler);
                }, 0);
            }
        }

        // ==============================
        // PROFILE MODAL FUNCTIONS
        // ==============================

        function showProfileModal() {
            hideSettingsModal();
            toggleDropdown();
            showProfileModalOriginal();
        }

        async function showProfileModalOriginal() {
            try {
                const userDoc = await db.collection('users').doc(AppState.currentUser.uid).get();
                
                if (!userDoc.exists) {
                    showToast('User data not found');
                    return;
                }
                
                const userData = userDoc.data();
                AppState.userProfileData = userData;
                
                document.getElementById('profileName').value = userData.name || '';
                document.getElementById('profileUsername').value = userData.username || '';
                document.getElementById('profileAbout').value = userData.about || '';
                document.getElementById('profileEmail').value = userData.email || '';
                document.getElementById('profileGender').value = userData.gender || '';
                
                initAvatarOptions(userData);
                
                document.getElementById('profileModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error loading profile:', error);
                showToast('Error loading profile');
            }
        }

        function hideProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }

        function initAvatarOptions(userData) {
            const avatarOptionsContainer = document.getElementById('avatarOptions');
            avatarOptionsContainer.innerHTML = '';
            
            const allAvatars = [...defaultAvatarOptions];
            if (userData.customAvatars) {
                allAvatars.push(...userData.customAvatars);
            }
            
            allAvatars.forEach((avatar) => {
                const img = document.createElement('img');
                img.src = avatar;
                img.className = 'avatar-option';
                if (avatar === userData.photoURL) {
                    img.classList.add('selected');
                }
                img.onclick = () => {
                    document.querySelectorAll('.avatar-option').forEach(a => a.classList.remove('selected'));
                    img.classList.add('selected');
                };
                avatarOptionsContainer.appendChild(img);
            });
        }

        async function addCustomAvatar() {
            const urlInput = document.getElementById('customAvatarUrl');
            const url = urlInput.value.trim();
            
            if (!url) {
                showToast('Please enter a valid URL');
                return;
            }
            
            try {
                new URL(url);
            } catch (e) {
                showToast('Please enter a valid image URL');
                return;
            }
            
            try {
                const userDoc = await db.collection('users').doc(AppState.currentUser.uid).get();
                const userData = userDoc.data();
                const customAvatars = userData.customAvatars || [];
                
                if (!customAvatars.includes(url)) {
                    customAvatars.push(url);
                    await db.collection('users').doc(AppState.currentUser.uid).update({
                        customAvatars: customAvatars
                    });
                    
                    initAvatarOptions({...userData, customAvatars});
                    urlInput.value = '';
                    showToast('Custom avatar added!');
                } else {
                    showToast('Avatar already exists');
                }
            } catch (error) {
                console.error('Error adding custom avatar:', error);
                showToast('Error adding avatar');
            }
        }

        async function updateProfile() {
            const name = document.getElementById('profileName').value.trim();
            const username = document.getElementById('profileUsername').value.trim().toLowerCase();
            const about = document.getElementById('profileAbout').value.trim();
            const gender = document.getElementById('profileGender').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const selectedAvatar = document.querySelector('.avatar-option.selected');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            
            if (!name) {
                showToast('Please enter your name');
                return;
            }
            
            if (!username) {
                showToast('Please enter a username');
                return;
            }
            
            const originalText = showLoader(saveProfileBtn);
            
            try {
                if (username !== AppState.userProfileData.username) {
                    const usernameSnapshot = await db.collection('users')
                        .where('username', '==', username)
                        .get();
                    
                    let usernameTaken = false;
                    usernameSnapshot.forEach(doc => {
                        if (doc.id !== AppState.currentUser.uid) {
                            usernameTaken = true;
                        }
                    });
                    
                    if (usernameTaken) {
                        showToast('Username already taken by another user');
                        hideLoader(saveProfileBtn, originalText);
                        return;
                    }
                }
                
                const updates = {
                    name: name,
                    username: username,
                    about: about,
                    gender: gender
                };
                
                if (selectedAvatar) {
                    updates.photoURL = selectedAvatar.src;
                    document.getElementById('userAvatar').src = selectedAvatar.src;
                }
                
                await db.collection('users').doc(AppState.currentUser.uid).update(updates);
                
                document.getElementById('userName').textContent = name;
                AppState.userProfileData = { ...AppState.userProfileData, ...updates };
                
                if (newPassword) {
                    if (newPassword.length < 6) {
                        showToast('Password must be at least 6 characters');
                        hideLoader(saveProfileBtn, originalText);
                        return;
                    }
                    
                    if (newPassword !== confirmPassword) {
                        showToast('Passwords do not match');
                        hideLoader(saveProfileBtn, originalText);
                        return;
                    }
                    
                    try {
                        await AppState.currentUser.updatePassword(newPassword);
                        
                        document.getElementById('newPassword').value = '';
                        document.getElementById('confirmPassword').value = '';
                        showToast('Password updated successfully');
                        
                    } catch (authError) {
                        console.error('Password update error:', authError);
                        showToast('Error updating password: ' + authError.message);
                        hideLoader(saveProfileBtn, originalText);
                        return;
                    }
                }
                
                hideProfileModal();
                showToast('Profile updated successfully!');
                
                loadAllUsers();
                
            } catch (error) {
                console.error('Error updating profile:', error);
                showToast('Error updating profile: ' + error.message);
            } finally {
                hideLoader(saveProfileBtn, originalText);
            }
        }

        // ==============================
        // ORIGINAL FUNCTIONS
        // ==============================

        async function signOut() {
            try {
                if (AppState.currentUser) {
                    await updateUserStatus(false);
                }
                
                cleanupListeners();
                
                await auth.signOut();
                hideProfileModal();
                hideSettingsModal();
                showToast('Signed out successfully');
            } catch (error) {
                console.error('Error signing out:', error);
                showToast('Error signing out', 3000);
            }
        }

        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(AppState.currentUser.uid).get();
                
                if (!userDoc.exists) {
                    await signOut();
                    return;
                }
                
                const userData = userDoc.data();
                AppState.userProfileData = userData;
                
                document.getElementById('userName').textContent = userData.name;
                document.getElementById('userAvatar').src = userData.photoURL;
                document.getElementById('userStatus').textContent = userData.about;
                
                if (userData.settings && userData.settings.theme) {
                    applyTheme(userData.settings.theme);
                }
                
                await updateUserStatus(true);
                
                initAvatarOptions(userData);
                
            } catch (error) {
                console.error('Error loading user data:', error);
                showToast('Error loading user data', 3000);
            }
        }

        async function updateUserStatus(online) {
            if (!AppState.currentUser) return;
            
            try {
                AppState.isOnline = online;
                const updateData = {
                    online: online,
                    lastSeen: FieldValue.serverTimestamp()
                };
                
                if (online) {
                    updateData.typingTo = null;
                }
                
                await db.collection('users').doc(AppState.currentUser.uid).update(updateData);
            } catch (error) {
                console.error('Error updating user status:', error);
            }
        }

        function setupUserStatusListeners() {
            document.addEventListener('visibilitychange', () => {
                if (AppState.currentUser) {
                    const isOnline = !document.hidden;
                    if (isOnline !== AppState.isOnline) {
                        updateUserStatus(isOnline);
                    }
                }
            });
            
            window.addEventListener('beforeunload', () => {
                if (AppState.currentUser) {
                    updateUserStatus(false);
                }
            });
        }

        async function loadAllUsers() {
            try {
                const snapshot = await db.collection('users')
                    .where('uid', '!=', AppState.currentUser.uid)
                    .get();
                
                AppState.allUsers = [];
                snapshot.forEach(doc => {
                    AppState.allUsers.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                updateUsersList();
                setupUsersRealtimeListener();
                
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        function setupUsersRealtimeListener() {
            const unsubscribe = db.collection('users')
                .where('uid', '!=', AppState.currentUser.uid)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        const userData = change.doc.data();
                        const index = AppState.allUsers.findIndex(u => u.id === change.doc.id);
                        
                        if (change.type === 'added' || change.type === 'modified') {
                            if (index > -1) {
                                AppState.allUsers[index] = { id: change.doc.id, ...userData };
                            } else {
                                AppState.allUsers.push({ id: change.doc.id, ...userData });
                            }
                        } else if (change.type === 'removed') {
                            AppState.allUsers.splice(index, 1);
                        }
                        
                        updateUsersList();
                        updateUserInChatList(change.doc.id, userData);
                    });
                });
            
            AppState.activeListeners.push(unsubscribe);
        }

        function updateUsersList() {
            const usersList = document.getElementById('usersList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            const filteredUsers = AppState.allUsers.filter(user => 
                user.name.toLowerCase().includes(searchTerm) ||
                (user.username && user.username.includes(searchTerm)) ||
                user.email.toLowerCase().includes(searchTerm)
            );
            
            if (filteredUsers.length === 0) {
                usersList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #8696a0;">
                        <i class="fas fa-user-slash" style="font-size: 48px;"></i>
                        <p>No users found</p>
                        ${searchTerm ? '<p style="font-size: 14px; margin-top: 10px;">Try a different search term</p>' : ''}
                    </div>
                `;
                return;
            }
            
            usersList.innerHTML = '';
            
            filteredUsers.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'user-list-item';
                userElement.onclick = () => startNewChat(user.id);
                
                userElement.innerHTML = `
                    <div style="position: relative;">
                        <img src="${user.photoURL || defaultAvatarOptions[0]}" alt="${user.name}" class="chat-avatar" onerror="this.src='${defaultAvatarOptions[0]}'">
                        ${user.online ? '<div class="online-indicator"></div>' : ''}
                    </div>
                    <div class="user-list-info">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="user-list-name">${user.name}</div>
                            ${user.username ? `<span class="username-badge">@${user.username}</span>` : ''}
                        </div>
                        <div class="user-list-status">
                            ${user.online ? 'Online' : 'Last seen ' + formatLastSeen(user.lastSeen)}
                        </div>
                    </div>
                `;
                
                usersList.appendChild(userElement);
            });
        }

        function listenForChats() {
            const unsubscribe = db.collection('chats')
                .where('participants', 'array-contains', AppState.currentUser.uid)
                .onSnapshot(snapshot => {
                    AppState.userChats = [];
                    snapshot.forEach(doc => {
                        AppState.userChats.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    AppState.userChats.sort((a, b) => {
                        const timeA = a.lastActivity ? a.lastActivity.toMillis() : 0;
                        const timeB = b.lastActivity ? b.lastActivity.toMillis() : 0;
                        return timeB - timeA;
                    });
                    
                    updateChatList();
                });
            
            AppState.activeListeners.push(unsubscribe);
        }

        function updateChatList() {
            const chatsList = document.getElementById('chatsList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            const filteredChats = AppState.userChats.filter(chat => {
                const otherUserId = chat.participants.find(id => id !== AppState.currentUser.uid);
                const otherUser = AppState.allUsers.find(u => u.id === otherUserId);
                return otherUser && (
                    otherUser.name.toLowerCase().includes(searchTerm) ||
                    (otherUser.username && otherUser.username.includes(searchTerm)) ||
                    (chat.lastMessage || '').toLowerCase().includes(searchTerm)
                );
            });
            
            if (filteredChats.length === 0) {
                if (searchTerm) {
                    chatsList.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: #8696a0;">
                            <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <p>No chats match your search</p>
                        </div>
                    `;
                } else {
                    chatsList.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px; color: #8696a0;">
                            <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <p>No chats yet</p>
                            <p style="font-size: 14px; margin-top: 10px;">Start a new conversation</p>
                        </div>
                    `;
                }
                return;
            }
            
            chatsList.innerHTML = '';
            
            filteredChats.forEach(chat => {
                const otherUserId = chat.participants.find(id => id !== AppState.currentUser.uid);
                const otherUser = AppState.allUsers.find(u => u.id === otherUserId);
                
                if (!otherUser) return;
                
                const chatElement = document.createElement('div');
                chatElement.className = 'chat-item';
                chatElement.setAttribute('data-user-id', otherUserId);
                chatElement.onclick = () => selectChat(chat.id, otherUser);
                
                if (AppState.selectedChatId === chat.id) {
                    chatElement.classList.add('active');
                }
                
                const unreadCount = (chat.unreadFor && chat.unreadFor[AppState.currentUser.uid]) || 0;
                
                chatElement.innerHTML = `
                    <div style="position: relative;">
                        <img src="${otherUser.photoURL || defaultAvatarOptions[0]}" alt="${otherUser.name}" class="chat-avatar" onerror="this.src='${defaultAvatarOptions[0]}'">
                        ${otherUser.online ? '<div class="online-indicator"></div>' : ''}
                    </div>
                    <div class="chat-info">
                        <div class="chat-header">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="chat-name">${otherUser.name}</div>
                                ${otherUser.username ? `<span class="username-badge">@${otherUser.username}</span>` : ''}
                            </div>
                            <div class="chat-time">${formatTime(chat.lastActivity)}</div>
                        </div>
                        <div class="chat-preview">
                            <div class="last-message">${chat.lastMessage || 'Start a conversation'}</div>
                            ${unreadCount > 0 ? `<div class="unread-count">${unreadCount}</div>` : ''}
                        </div>
                    </div>
                `;
                
                chatsList.appendChild(chatElement);
            });
        }

        function updateUserInChatList(userId, userData) {
            const chatItem = document.querySelector(`[data-user-id="${userId}"]`);
            if (chatItem) {
                const onlineIndicator = chatItem.querySelector('.online-indicator');
                if (onlineIndicator) {
                    onlineIndicator.style.display = userData.online ? 'block' : 'none';
                }
            }
            
            if (AppState.selectedUserId === userId) {
                const statusElement = document.getElementById('chatPartnerStatus');
                const typingIndicator = document.getElementById('typingIndicator');
                
                if (userData.typingTo === AppState.selectedChatId) {
                    typingIndicator.style.display = 'flex';
                    statusElement.style.display = 'none';
                } else {
                    typingIndicator.style.display = 'none';
                    statusElement.style.display = 'block';
                    statusElement.textContent = userData.online ? 
                        'Online' : 
                        'Last seen ' + formatLastSeen(userData.lastSeen);
                }
            }
        }

        async function startNewChat(userId) {
            if (userId === AppState.currentUser.uid) {
                showToast('Cannot start chat with yourself');
                return;
            }
            
            const otherUser = AppState.allUsers.find(u => u.id === userId);
            if (!otherUser) {
                showToast('User not found');
                return;
            }
            
            const existingChat = AppState.userChats.find(chat => 
                chat.participants.includes(userId)
            );
            
            if (existingChat) {
                selectChat(existingChat.id, otherUser);
                return;
            }
            
            const chatId = [AppState.currentUser.uid, userId].sort().join('_');
            
            try {
                await db.collection('chats').doc(chatId).set({
                    participants: [AppState.currentUser.uid, userId],
                    lastMessage: '',
                    lastActivity: FieldValue.serverTimestamp(),
                    unreadFor: {
                        [AppState.currentUser.uid]: 0,
                        [userId]: 0
                    },
                    createdAt: FieldValue.serverTimestamp()
                });
                
                selectChat(chatId, otherUser);
                showToast('Chat started');
                
            } catch (error) {
                console.error('Error creating chat:', error);
                showToast('Error starting chat');
            }
        }

        async function selectChat(chatId, user) {
            if (!user || !chatId) return;
            
            AppState.selectedChatId = chatId;
            AppState.selectedUserId = user.id;
            AppState.lastVisibleMessage = null;
            AppState.hasMoreMessages = true;
            AppState.displayedMessageIds.clear();
            
            document.querySelectorAll('.chat-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const activeChat = document.querySelector(`[data-user-id="${user.id}"]`);
            if (activeChat) {
                activeChat.classList.add('active');
            }
            
            document.getElementById('chatPartnerName').textContent = user.name;
            document.getElementById('chatPartnerAvatar').src = user.photoURL || defaultAvatarOptions[0];
            document.getElementById('chatPartnerAvatar').onerror = function() {
                this.src = defaultAvatarOptions[0];
            };
            
            const statusElement = document.getElementById('chatPartnerStatus');
            statusElement.textContent = user.online ? 'Online' : 'Last seen ' + formatLastSeen(user.lastSeen);
            
            try {
                const chatDoc = await db.collection('chats').doc(chatId).get();
                if (chatDoc.exists) {
                    const chatData = chatDoc.data();
                    const unreadFor = chatData.unreadFor || {};
                    unreadFor[AppState.currentUser.uid] = 0;
                    
                    await db.collection('chats').doc(chatId).update({
                        unreadFor: unreadFor
                    });
                }
            } catch (error) {
                console.error('Error clearing unread count:', error);
            }
            
            if (window.innerWidth <= 768) {
                showChatArea();
            }
            
            document.getElementById('searchContainer').classList.add('hidden');
            
            await loadMessages();
            
            document.getElementById('messageInputArea').style.display = 'flex';
            document.getElementById('messageInput').focus();
            
            setupTypingListener();
            
            switchTab('chats');
            
            if (window.innerWidth <= 768) {
                window.history.pushState({ chatSelected: true }, '');
            }
        }

        function showSidebar() {
            document.getElementById('sidebar').style.display = 'flex';
            document.getElementById('chatArea').classList.remove('active');
            document.querySelector('.back-button').style.display = 'none';
            
            document.getElementById('searchContainer').classList.remove('hidden');
            
            AppState.selectedChatId = null;
            AppState.selectedUserId = null;
            AppState.displayedMessageIds.clear();
            
            document.getElementById('messageInputArea').style.display = 'none';
            
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #8696a0;">
                    <i class="fas fa-comments" style="font-size: 48px;"></i>
                    <p style="margin-top: 15px;">Select a chat to start messaging</p>
                </div>
            `;
            
            document.getElementById('chatPartnerName').textContent = 'Select a chat';
            document.getElementById('chatPartnerAvatar').src = '';
            document.getElementById('chatPartnerStatus').textContent = '';
            
            if (window.history.state && window.history.state.chatSelected) {
                window.history.back();
            }
        }

        function showChatArea() {
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('chatArea').classList.add('active');
            document.querySelector('.back-button').style.display = 'block';
        }

        function switchTab(tabName) {
            AppState.currentTab = tabName;
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent.includes(tabName.toUpperCase()));
            });
            
            if (tabName === 'chats') {
                document.getElementById('chatsList').style.display = 'block';
                document.getElementById('usersList').style.display = 'none';
                updateChatList();
            } else if (tabName === 'users') {
                document.getElementById('chatsList').style.display = 'none';
                document.getElementById('usersList').style.display = 'block';
                updateUsersList();
            }
            
            document.getElementById('searchInput').placeholder = 
                tabName === 'chats' ? 'Search chats...' : 'Search users...';
        }

        const debouncedSearch = debounce(() => {
            if (AppState.currentTab === 'chats') {
                updateChatList();
            } else if (AppState.currentTab === 'users') {
                updateUsersList();
            }
        }, 300);

        async function loadMessages(loadMore = false) {
            const messagesContainer = document.getElementById('messagesContainer');
            
            if (!loadMore) {
                messagesContainer.innerHTML = '';
                AppState.lastVisibleMessage = null;
                AppState.hasMoreMessages = true;
                AppState.displayedMessageIds.clear();
            }
            
            if (!AppState.selectedChatId || !AppState.hasMoreMessages) return;
            
            try {
                let query = db.collection('chats').doc(AppState.selectedChatId)
                    .collection('messages')
                    .orderBy('timestamp', 'desc')
                    .limit(AppState.pageSize);
                
                if (loadMore && AppState.lastVisibleMessage) {
                    query = query.startAfter(AppState.lastVisibleMessage);
                }
                
                const snapshot = await query.get();
                
                if (snapshot.empty) {
                    if (!loadMore) {
                        messagesContainer.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #8696a0;">
                                <i class="fas fa-comment-slash" style="font-size: 48px;"></i>
                                <p style="margin-top: 15px;">No messages yet</p>
                                <p style="font-size: 14px;">Say hello to start the conversation!</p>
                            </div>
                        `;
                    }
                    AppState.hasMoreMessages = false;
                    return;
                }
                
                const messages = [];
                snapshot.forEach(doc => {
                    messages.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                messages.reverse();
                
                if (!loadMore) {
                    messagesContainer.innerHTML = '';
                }
                
                let currentDate = null;
                messages.forEach(message => {
                    const messageDate = message.timestamp.toDate().toDateString();
                    
                    if (currentDate !== messageDate) {
                        currentDate = messageDate;
                        const dateDiv = document.createElement('div');
                        dateDiv.className = 'message-date';
                        dateDiv.innerHTML = `<span class="date-label">${formatDate(message.timestamp.toDate())}</span>`;
                        messagesContainer.prepend(dateDiv);
                    }
                    
                    if (!AppState.displayedMessageIds.has(message.id)) {
                        displayMessage(message.id, message, !loadMore);
                        AppState.displayedMessageIds.add(message.id);
                    }
                });
                
                if (snapshot.docs.length > 0) {
                    AppState.lastVisibleMessage = snapshot.docs[snapshot.docs.length - 1];
                }
                
                AppState.hasMoreMessages = snapshot.docs.length === AppState.pageSize;
                
                if (!loadMore) {
                    setTimeout(() => {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, 100);
                }
                
                if (!loadMore) {
                    setupMessagesRealtimeListener();
                    markMessagesAsSeen();
                }
                
            } catch (error) {
                console.error('Error loading messages:', error);
                showToast('Error loading messages');
            }
        }

        function setupMessagesRealtimeListener() {
            const existingListener = AppState.activeListeners.find(l => l.name === 'messages');
            if (existingListener) {
                existingListener();
                AppState.activeListeners = AppState.activeListeners.filter(l => l !== existingListener);
            }
            
            if (!AppState.selectedChatId) return;
            
            const unsubscribe = db.collection('chats').doc(AppState.selectedChatId)
                .collection('messages')
                .orderBy('timestamp', 'desc')
                .limit(1)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const message = change.doc.data();
                            
                            if (!AppState.displayedMessageIds.has(change.doc.id)) {
                                displayMessage(change.doc.id, message, true);
                                AppState.displayedMessageIds.add(change.doc.id);
                                
                                const messagesContainer = document.getElementById('messagesContainer');
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                                
                                if (message.senderId !== AppState.currentUser.uid) {
                                    markMessageAsSeen(change.doc.id);
                                }
                            }
                        }
                        
                        if (change.type === 'modified') {
                            updateMessageStatus(change.doc.id, change.doc.data());
                        }
                    });
                }, error => {
                    console.error('Messages listener error:', error);
                });
            
            unsubscribe.name = 'messages';
            AppState.activeListeners.push(unsubscribe);
        }

        function displayMessage(messageId, message, append = true) {
            const messagesContainer = document.getElementById('messagesContainer');
            const isSent = message.senderId === AppState.currentUser.uid;
            
            if (messagesContainer.innerHTML.includes('fa-comment-slash')) {
                messagesContainer.innerHTML = '';
            }
            
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `message-wrapper ${isSent ? 'sent' : 'received'}`;
            messageWrapper.id = `message-${messageId}`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
            
            messageBubble.innerHTML = `
                <div>${escapeHtml(message.text)}</div>
                <div class="message-info">
                    <span class="message-time">${formatMessageTime(message.timestamp)}</span>
                    ${isSent ? `
                        <span class="message-status ${message.seen ? 'seen-status' : ''}">
                            ${getMessageStatusIcon(message)}
                        </span>
                    ` : ''}
                </div>
            `;
            
            messageBubble.addEventListener('mousedown', (e) => startLongPress(e, messageId, message));
            messageBubble.addEventListener('touchstart', (e) => {
                e.preventDefault();
                startLongPress(e, messageId, message);
            }, { passive: false });
            messageBubble.addEventListener('mouseup', cancelLongPress);
            messageBubble.addEventListener('touchend', cancelLongPress);
            messageBubble.addEventListener('mouseleave', cancelLongPress);
            messageBubble.addEventListener('touchcancel', cancelLongPress);
            
            messageWrapper.appendChild(messageBubble);
            
            if (append) {
                messagesContainer.appendChild(messageWrapper);
            } else {
                messagesContainer.prepend(messageWrapper);
            }
        }

        function updateMessageStatus(messageId, message) {
            const messageElement = document.getElementById(`message-${messageId}`);
            if (messageElement) {
                const statusElement = messageElement.querySelector('.message-status');
                if (statusElement) {
                    statusElement.innerHTML = getMessageStatusIcon(message);
                    statusElement.className = `message-status ${message.seen ? 'seen-status' : ''}`;
                }
            }
        }

        function getMessageStatusIcon(message) {
            if (message.seen) {
                return '<i class="fas fa-check-double"></i>';
            } else if (message.delivered) {
                return '<i class="fas fa-check-double"></i>';
            } else if (message.sent) {
                return '<i class="fas fa-check"></i>';
            }
            return '<i class="fas fa-clock"></i>';
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !AppState.selectedChatId) return;
            
            await stopTyping();
            
            const messageData = {
                text: text,
                senderId: AppState.currentUser.uid,
                timestamp: FieldValue.serverTimestamp(),
                sent: true,
                delivered: false,
                seen: false
            };
            
            try {
                await db.collection('chats').doc(AppState.selectedChatId)
                    .collection('messages').add(messageData);
                
                const chatDoc = await db.collection('chats').doc(AppState.selectedChatId).get();
                const chatData = chatDoc.data();
                const otherUserId = chatData.participants.find(id => id !== AppState.currentUser.uid);
                
                const unreadFor = chatData.unreadFor || {};
                unreadFor[otherUserId] = (unreadFor[otherUserId] || 0) + 1;
                unreadFor[AppState.currentUser.uid] = 0;
                
                await db.collection('chats').doc(AppState.selectedChatId).update({
                    lastMessage: text,
                    lastActivity: FieldValue.serverTimestamp(),
                    unreadFor: unreadFor
                });
                
                input.value = '';
                input.style.height = 'auto';
                
                setTimeout(async () => {
                    try {
                        const latestMessage = await getLatestMessage(AppState.selectedChatId);
                        if (latestMessage && latestMessage.senderId === AppState.currentUser.uid) {
                            await db.collection('chats').doc(AppState.selectedChatId)
                                .collection('messages').doc(latestMessage.id).update({
                                    delivered: true
                                });
                        }
                    } catch (error) {
                        console.error('Error marking as delivered:', error);
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Error sending message:', error);
                showToast('Failed to send message');
            }
        }

        async function getLatestMessage(chatId) {
            try {
                const snapshot = await db.collection('chats').doc(chatId)
                    .collection('messages')
                    .orderBy('timestamp', 'desc')
                    .limit(1)
                    .get();
                
                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    return { id: doc.id, ...doc.data() };
                }
                return null;
            } catch (error) {
                console.error('Error getting latest message:', error);
                return null;
            }
        }

        async function handleTyping() {
            if (!AppState.selectedChatId || AppState.isTyping) return;
            
            AppState.isTyping = true;
            await db.collection('users').doc(AppState.currentUser.uid).update({
                typingTo: AppState.selectedChatId
            });
            
            if (AppState.typingTimeout) {
                clearTimeout(AppState.typingTimeout);
            }
            
            AppState.typingTimeout = setTimeout(async () => {
                await stopTyping();
            }, 2000);
        }

        async function stopTyping() {
            if (!AppState.isTyping) return;
            
            AppState.isTyping = false;
            if (AppState.typingTimeout) {
                clearTimeout(AppState.typingTimeout);
                AppState.typingTimeout = null;
            }
            
            try {
                await db.collection('users').doc(AppState.currentUser.uid).update({
                    typingTo: null
                });
            } catch (error) {
                console.error('Error stopping typing:', error);
            }
        }

        function setupTypingListener() {
            if (!AppState.selectedUserId) return;
            
            const unsubscribe = db.collection('users').doc(AppState.selectedUserId)
                .onSnapshot(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        const typingIndicator = document.getElementById('typingIndicator');
                        const statusElement = document.getElementById('chatPartnerStatus');
                        
                        if (userData.typingTo === AppState.selectedChatId) {
                            typingIndicator.style.display = 'flex';
                            statusElement.style.display = 'none';
                        } else {
                            typingIndicator.style.display = 'none';
                            statusElement.style.display = 'block';
                        }
                    }
                });
            
            AppState.activeListeners.push(unsubscribe);
        }

        async function markMessagesAsSeen() {
            if (!AppState.selectedChatId) return;
            
            try {
                const snapshot = await db.collection('chats').doc(AppState.selectedChatId)
                    .collection('messages')
                    .where('senderId', '==', AppState.selectedUserId)
                    .where('seen', '==', false)
                    .get();
                
                const batch = db.batch();
                
                snapshot.forEach(doc => {
                    const messageRef = db.collection('chats').doc(AppState.selectedChatId)
                        .collection('messages').doc(doc.id);
                    batch.update(messageRef, { seen: true });
                });
                
                if (snapshot.size > 0) {
                    await batch.commit();
                    
                    const chatDoc = await db.collection('chats').doc(AppState.selectedChatId).get();
                    if (chatDoc.exists) {
                        const chatData = chatDoc.data();
                        const unreadFor = chatData.unreadFor || {};
                        unreadFor[AppState.currentUser.uid] = 0;
                        
                        await db.collection('chats').doc(AppState.selectedChatId).update({
                            unreadFor: unreadFor
                        });
                    }
                }
            } catch (error) {
                console.error('Error marking messages as seen:', error);
            }
        }

        async function markMessageAsSeen(messageId) {
            if (!AppState.selectedChatId) return;
            
            try {
                await db.collection('chats').doc(AppState.selectedChatId)
                    .collection('messages').doc(messageId).update({
                        seen: true
                    });
            } catch (error) {
                console.error('Error marking message as seen:', error);
            }
        }

        function startLongPress(e, messageId, message) {
            e.preventDefault();
            e.stopPropagation();
            
            AppState.longPressTimer = setTimeout(() => {
                showMessageOptions(e, messageId, message);
            }, 600);
        }

        function cancelLongPress() {
            if (AppState.longPressTimer) {
                clearTimeout(AppState.longPressTimer);
                AppState.longPressTimer = null;
            }
        }

        function showMessageOptions(e, messageId, message) {
            cancelLongPress();
            
            const isSent = message.senderId === AppState.currentUser.uid;
            
            let clientX, clientY;
            if (e.type === 'touchstart' || e.type === 'touchend') {
                const touch = e.touches[0] || e.changedTouches[0];
                clientX = touch.clientX;
                clientY = touch.clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            const existingMenu = document.querySelector('.message-selection');
            if (existingMenu) {
                existingMenu.remove();
            }
            
            const menu = document.createElement('div');
            menu.className = 'message-selection';
            menu.id = 'messageSelectionMenu';
            
            menu.innerHTML = `
                ${isSent ? `
                    <div class="selection-item delete" onclick="initiateDelete('${messageId}')">
                        <i class="fas fa-trash-alt"></i>
                        <span>Delete for everyone</span>
                    </div>
                    <div class="selection-item" onclick="deleteForMe('${messageId}')">
                        <i class="fas fa-trash"></i>
                        <span>Delete for me</span>
                    </div>
                ` : `
                    <div class="selection-item delete" onclick="deleteForMe('${messageId}')">
                        <i class="fas fa-trash-alt"></i>
                        <span>Delete</span>
                    </div>
                `}
                <div class="selection-item" onclick="copyMessage('${escapeHtml(message.text)}')">
                    <i class="fas fa-copy"></i>
                    <span>Copy</span>
                </div>
            `;
            
            document.body.appendChild(menu);
            
            const menuWidth = menu.offsetWidth;
            const menuHeight = menu.offsetHeight;
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            
            let left = clientX - (menuWidth / 2);
            let top = clientY - menuHeight - 10;
            
            if (left < 10) left = 10;
            if (left + menuWidth > viewportWidth - 10) {
                left = viewportWidth - menuWidth - 10;
            }
            
            if (top < 10) {
                top = clientY + 10;
            }
            
            if (top + menuHeight > viewportHeight - 10) {
                top = clientY - menuHeight - 10;
            }
            
            menu.style.left = left + 'px';
            menu.style.top = top + 'px';
            menu.style.display = 'block';
            
            const closeMenuHandler = (clickEvent) => {
                if (!menu.contains(clickEvent.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenuHandler);
                    document.removeEventListener('touchstart', closeMenuHandler);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', closeMenuHandler);
                document.addEventListener('touchstart', closeMenuHandler);
            }, 10);
        }

        function initiateDelete(messageId) {
            AppState.messageToDelete = messageId;
            
            const menu = document.getElementById('messageSelectionMenu');
            if (menu) menu.remove();
            
            db.collection('chats').doc(AppState.selectedChatId)
                .collection('messages').doc(messageId).get()
                .then(doc => {
                    if (doc.exists) {
                        const message = doc.data();
                        const preview = message.text.length > 50 ? 
                            message.text.substring(0, 50) + '...' : 
                            message.text;
                        
                        document.getElementById('deleteMessageText').textContent = 
                            `Delete "${preview}" for everyone?`;
                    }
                    
                    document.getElementById('deleteConfirmation').style.display = 'flex';
                })
                .catch(error => {
                    console.error('Error getting message:', error);
                    showToast('Error loading message');
                });
        }

        function deleteForMe(messageId) {
            const menu = document.getElementById('messageSelectionMenu');
            if (menu) menu.remove();
            
            hideMessage(messageId);
            showToast('Message deleted for you');
        }

        async function confirmDelete() {
            if (!AppState.messageToDelete || !AppState.selectedChatId) {
                cancelDelete();
                return;
            }
            
            try {
                await db.collection('chats').doc(AppState.selectedChatId)
                    .collection('messages').doc(AppState.messageToDelete).delete();
                
                await updateLastMessageAfterDelete();
                showToast('Message deleted for everyone');
                
            } catch (error) {
                console.error('Error deleting message:', error);
                showToast('Failed to delete message');
            } finally {
                cancelDelete();
            }
        }

        function cancelDelete() {
            AppState.messageToDelete = null;
            document.getElementById('deleteConfirmation').style.display = 'none';
        }

        function hideMessage(messageId) {
            const messageElement = document.getElementById(`message-${messageId}`);
            if (messageElement) {
                messageElement.style.display = 'none';
            }
        }

        async function updateLastMessageAfterDelete() {
            if (!AppState.selectedChatId) return;
            
            try {
                const snapshot = await db.collection('chats').doc(AppState.selectedChatId)
                    .collection('messages')
                    .orderBy('timestamp', 'desc')
                    .limit(1)
                    .get();
                
                if (snapshot.empty) {
                    await db.collection('chats').doc(AppState.selectedChatId).update({
                        lastMessage: '',
                        lastActivity: FieldValue.serverTimestamp()
                    });
                } else {
                    const lastMessage = snapshot.docs[0].data();
                    await db.collection('chats').doc(AppState.selectedChatId).update({
                        lastMessage: lastMessage.text,
                        lastActivity: FieldValue.serverTimestamp()
                    });
                }
            } catch (error) {
                console.error('Error updating last message:', error);
            }
        }

        function copyMessage(text) {
            const menu = document.getElementById('messageSelectionMenu');
            if (menu) menu.remove();
            
            navigator.clipboard.writeText(text)
                .then(() => {
                    showToast('Copied to clipboard');
                })
                .catch(err => {
                    console.error('Failed to copy:', err);
                    showToast('Failed to copy');
                });
        }

        // ==============================
        // HELPER FUNCTIONS
        // ==============================

        function applyTheme(theme) {
            const body = document.body;
            const lightMode = theme === 'light' || (theme === 'system' && window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches);
            
            if (lightMode) {
                body.classList.add('light-mode');
            } else {
                body.classList.remove('light-mode');
            }
            
            document.getElementById('themeToggle').checked = !lightMode;
        }

        function toggleTheme() {
            const toggle = document.getElementById('themeToggle');
            const theme = toggle.checked ? 'dark' : 'light';
            showToast(`Theme switched to ${theme}`);
        }

        function toggleNotifications() {
            const toggle = document.getElementById('notificationsToggle');
            showToast(`Notifications ${toggle.checked ? 'enabled' : 'disabled'}`);
        }

        function showPrivacySettings() {
            showSettingsModal();
        }

        function showHelp() {
            showHelpCenter();
        }

        function showAbout() {
            showToast('Flow Chat v1.0.0 - Professional Messaging App');
        }

        function showAttachmentOptions() {
            showToast('Attachment options - Coming Soon');
        }

        function showEmojiPicker() {
            showToast('Emoji picker - Coming Soon');
        }

        function showTerms() {
            showToast('Terms of Service - Full version available at our website');
        }

        function showPrivacy() {
            showToast('Privacy Policy - Full version available at our website');
        }

        function showForgotPassword() {
            showToast('Password reset - Coming Soon');
        }

        function signInWithGoogle() {
            showToast('Google sign-in - Coming Soon');
        }

        // ==============================
        // EVENT HANDLERS
        // ==============================

        function handleInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function setupBackButton() {
            window.addEventListener('popstate', function(event) {
                if (AppState.selectedChatId && window.innerWidth <= 768) {
                    showSidebar();
                }
            });
        }

        function setupMobileResponsive() {
            function handleResize() {
                if (window.innerWidth <= 768) {
                    document.querySelector('.back-button').style.display = 'block';
                    if (AppState.selectedChatId) {
                        showChatArea();
                    }
                } else {
                    document.querySelector('.back-button').style.display = 'none';
                    document.getElementById('sidebar').style.display = 'flex';
                    document.getElementById('chatArea').classList.remove('active');
                }
            }
            
            window.addEventListener('resize', handleResize);
            handleResize();
        }

        function cleanupListeners() {
            AppState.activeListeners.forEach(unsubscribe => {
                if (typeof unsubscribe === 'function') {
                    unsubscribe();
                }
            });
            AppState.activeListeners = [];
            AppState.displayedMessageIds.clear();
        }

        // ==============================
        // AUTH STATE HANDLER
        // ==============================

        async function handleAuthStateChange(user) {
            if (user) {
                AppState.currentUser = user;
                
                try {
                    await loadUserData();
                    
                    document.getElementById('authContainer').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'flex';
                    
                    setupUserStatusListeners();
                    loadAllUsers();
                    listenForChats();
                    
                } catch (error) {
                    console.error('Error during auth state change:', error);
                    showToast('Error loading app data');
                }
                
            } else {
                AppState.currentUser = null;
                AppState.userProfileData = null;
                cleanupListeners();
                
                document.getElementById('authContainer').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
                showSignUp();
            }
        }

        // ==============================
        // INITIALIZATION
        // ==============================

        document.addEventListener('DOMContentLoaded', function() {
            setupPWA();
            setupManifest();
            setupBackButton();
            setupMobileResponsive();
            
            auth.onAuthStateChanged(handleAuthStateChange);
            
            document.getElementById('avatarPreview').src = defaultAvatarOptions[0];
            updateStepUI();
            
            initializeCountrySelect();
            
            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('dropdownMenu');
                if (dropdown && dropdown.classList.contains('show') && 
                    !dropdown.contains(e.target) && 
                    !e.target.closest('.header-icons')) {
                    dropdown.classList.remove('show');
                }
            });
        });

    </script>
</body>
</html>
